async function t(t,s={}){const i={env:Object.assign(Object.create(globalThis),s.env||{},{abort(t,s,i,e){t=h(t>>>0),s=h(s>>>0),i>>>=0,e>>>=0,(()=>{throw Error(`${t} in ${s}:${i}:${e}`)})()}})},{exports:e}=await WebAssembly.instantiate(t,i),_=e.memory||s.env.memory,m=Object.setPrototypeOf({define_player_target_position:(t,s)=>0!=e.define_player_target_position(t,s),get_game_settings:()=>a(n,2,e.get_game_settings()>>>0),get_game_data:()=>a(n,2,e.get_game_data()>>>0)},e);function h(t){if(!t)return null;const s=t+new Uint32Array(_.buffer)[t-4>>>2]>>>1,i=new Uint16Array(_.buffer);let e=t>>>1,m="";for(;s-e>1024;)m+=String.fromCharCode(...i.subarray(e,e+=1024));return m+String.fromCharCode(...i.subarray(e,s))}function a(t,s,i){if(!i)return null;const e=function(t){try{return o.getUint32(t,!0)}catch{return o=new DataView(_.buffer),o.getUint32(t,!0)}}(i-4)>>>s,m=new Array(e);for(let _=0;_<e;++_)m[_]=t(i+(_<<s>>>0));return m}let o=new DataView(_.buffer);function n(t){try{return o.getFloat32(t,!0)}catch{return o=new DataView(_.buffer),o.getFloat32(t,!0)}}return m}const{memory:s,create_game:i,add_monster:e,define_player_target_position:_,get_game_settings:m,game_update:h,get_game_data:a}=await(async s=>t(await(async()=>await globalThis.WebAssembly.compileStreaming(globalThis.fetch(s)))(),{}))(new URL("game_api.97377cac.wasm",import.meta.url));let o;var n;(n=o||(o={}))[n.LEVEL_WIDHT=0]="LEVEL_WIDHT",n[n.LEVEL_HEIGHT=1]="LEVEL_HEIGHT",n[n.TILE_SIZE=2]="TILE_SIZE",n[n.NAVMESH_VERTICES=3]="NAVMESH_VERTICES",n[n.NAVMESH_POLYGONS=4]="NAVMESH_POLYGONS",n[n.NAVMESH_SIZES=5]="NAVMESH_SIZES",n[n.PLAYER_POSITION=6]="PLAYER_POSITION",n[n.PLAYER_RADIUS=7]="PLAYER_RADIUS",n[n.PLAYER_MOVE=8]="PLAYER_MOVE",n[n.PLAYER_ANGLE=9]="PLAYER_ANGLE",n[n.MONSTERS_COUNT=10]="MONSTERS_COUNT",n[n.MONSTER_POSITION=11]="MONSTER_POSITION",n[n.MONSTER_RADIUS=12]="MONSTER_RADIUS",n[n.MONSTER_MOVE=13]="MONSTER_MOVE",n[n.MONSTER_ANGLE=14]="MONSTER_ANGLE",n[n.MONSTERS_TO_DELETE=15]="MONSTERS_TO_DELETE",n[n.TILES_TO_DELETE=16]="TILES_TO_DELETE",n[n.TILES_TO_CREATE=17]="TILES_TO_CREATE",n[n.LEVEL_TOTAL_TILES=18]="LEVEL_TOTAL_TILES";const r=[3,5,8,12,15,20,30,40,50];class c{m_matrix=new Float32Array(9);m_angle=0;m_scale_x=1;m_scale_y=1;constructor(){this.m_matrix[0]=1,this.m_matrix[1]=0,this.m_matrix[2]=0,this.m_matrix[3]=0,this.m_matrix[4]=1,this.m_matrix[5]=0,this.m_matrix[6]=0,this.m_matrix[7]=0,this.m_matrix[8]=1}matrix_array(){return this.m_matrix}set_matrix_array(t){for(let s=0;s<9;s++)this.m_matrix[s]=t[s]}set_translation(t,s){this.m_matrix[2]=t,this.m_matrix[5]=s}translation(){return[this.m_matrix[2],this.m_matrix[5]]}_update_rotation(){this.m_matrix[0]=Math.cos(this.m_angle)*this.m_scale_x,this.m_matrix[3]=Math.sin(this.m_angle)*this.m_scale_x,this.m_matrix[1]=-Math.sin(this.m_angle)*this.m_scale_y,this.m_matrix[4]=Math.cos(this.m_angle)*this.m_scale_y}set_rotation(t){this.m_angle=t,this._update_rotation()}rotation(){return this.m_angle}set_scale(t,s){this.m_scale_x=t,this.m_scale_y=s,this._update_rotation()}set_uniform_scale(t){this.m_scale_x=t,this.m_scale_y=t,this._update_rotation()}multiply(t,s){return[this.m_matrix[0]*t+this.m_matrix[1]*s+this.m_matrix[2],this.m_matrix[3]*t+this.m_matrix[4]*s+this.m_matrix[5]]}apply_scale(t){return t*(Math.sqrt(this.m_matrix[0]*this.m_matrix[0]+this.m_matrix[3]*this.m_matrix[3])+Math.sqrt(this.m_matrix[1]*this.m_matrix[1]+this.m_matrix[4]*this.m_matrix[4]))/2}compose_tfms(t){let s=new c;const i=this.matrix_array(),e=t.matrix_array();let _=[i[0]*e[0]+i[1]*e[3]+i[2]*e[6],i[0]*e[1]+i[1]*e[4]+i[2]*e[7],i[0]*e[2]+i[1]*e[5]+i[2]*e[8],i[3]*e[0]+i[4]*e[3]+i[5]*e[6],i[3]*e[1]+i[4]*e[4]+i[5]*e[7],i[3]*e[2]+i[4]*e[5]+i[5]*e[8],i[6]*e[0]+i[7]*e[3]+i[8]*e[6],i[6]*e[1]+i[7]*e[4]+i[8]*e[7],i[6]*e[2]+i[7]*e[5]+i[8]*e[8]];return s.set_matrix_array(_),s}_det2(t,s,i,e){return t*e-s*i}inverse(){const t=this.m_matrix[0]*this.m_matrix[4]*this.m_matrix[8]+this.m_matrix[2]*this.m_matrix[3]*this.m_matrix[7]+this.m_matrix[1]*this.m_matrix[5]*this.m_matrix[6]-this.m_matrix[2]*this.m_matrix[4]*this.m_matrix[6]-this.m_matrix[0]*this.m_matrix[5]*this.m_matrix[7]-this.m_matrix[1]*this.m_matrix[3]*this.m_matrix[8],s=[this._det2(this.m_matrix[4],this.m_matrix[5],this.m_matrix[7],this.m_matrix[8])/t,-1*this._det2(this.m_matrix[1],this.m_matrix[2],this.m_matrix[7],this.m_matrix[8])/t,this._det2(this.m_matrix[1],this.m_matrix[2],this.m_matrix[4],this.m_matrix[5])/t,-1*this._det2(this.m_matrix[3],this.m_matrix[5],this.m_matrix[6],this.m_matrix[8])/t,this._det2(this.m_matrix[0],this.m_matrix[2],this.m_matrix[6],this.m_matrix[8])/t,-1*this._det2(this.m_matrix[0],this.m_matrix[2],this.m_matrix[3],this.m_matrix[5])/t,this._det2(this.m_matrix[3],this.m_matrix[4],this.m_matrix[6],this.m_matrix[7])/t,-1*this._det2(this.m_matrix[0],this.m_matrix[1],this.m_matrix[6],this.m_matrix[7])/t,this._det2(this.m_matrix[0],this.m_matrix[1],this.m_matrix[3],this.m_matrix[4])/t];let i=new c;return i.set_matrix_array(s),i}toString(){let t="";return t+=this.m_matrix[0]+", "+this.m_matrix[1]+", "+this.m_matrix[2]+"\n",t+=this.m_matrix[3]+", "+this.m_matrix[4]+", "+this.m_matrix[5]+"\n",t+=this.m_matrix[6]+", "+this.m_matrix[7]+", "+this.m_matrix[8],t}}const l="rgba(91, 128, 78, 0.75)",x="rgba(234, 112, 23, 0.5)",f="rgba(48, 148, 233, 0.5)";class u{constructor(t,s){this.m_wtc_tfm=s,this.m_context=t}}class p extends u{m_posx_x=0;m_posx_y=0;m_size=0;m_type=1;constructor(t,s,i,e,_,m){super(t,s),this.m_posx_x=i,this.m_posx_y=e,this.m_size=_,this.m_type=m}draw(){const t=this.m_wtc_tfm.multiply(this.m_posx_x,this.m_posx_y),s=this.m_wtc_tfm.apply_scale(this.m_size);this.m_context.save(),this.m_context.lineWidth=.2,this.m_context.fillStyle="rgb(192, 192, 192)",this.m_context.strokeStyle="rgb(152, 152, 152)",this.m_context.beginPath(),0==this.m_type?this.m_context.rect(t[0],t[1],s,s):2==this.m_type?this.m_context.rect(t[0]+s/2,t[1]+s/2,s/2,s/2):3==this.m_type?this.m_context.rect(t[0],t[1]+s/2,s/2,s/2):4==this.m_type?this.m_context.rect(t[0]+s/2,t[1],s/2,s/2):5==this.m_type?this.m_context.rect(t[0],t[1],s/2,s/2):6==this.m_type?this.m_context.rect(t[0],t[1]+s/2,s,s/2):7==this.m_type?this.m_context.rect(t[0],t[1],s/2,s):8==this.m_type?this.m_context.rect(t[0],t[1],s,s/2):9==this.m_type?this.m_context.rect(t[0]+s/2,t[1],s/2,s):10==this.m_type?(this.m_context.moveTo(t[0],t[1]),this.m_context.lineTo(t[0],t[1]+s),this.m_context.lineTo(t[0]+s/2,t[1]+s),this.m_context.lineTo(t[0]+s/2,t[1]+s/2),this.m_context.lineTo(t[0]+s,t[1]+s/2),this.m_context.lineTo(t[0]+s,t[1])):11==this.m_type?(this.m_context.moveTo(t[0],t[1]),this.m_context.lineTo(t[0],t[1]+s/2),this.m_context.lineTo(t[0]+s/2,t[1]+s/2),this.m_context.lineTo(t[0]+s/2,t[1]+s),this.m_context.lineTo(t[0]+s,t[1]+s),this.m_context.lineTo(t[0]+s,t[1])):12==this.m_type?(this.m_context.moveTo(t[0],t[1]),this.m_context.lineTo(t[0],t[1]+s),this.m_context.lineTo(t[0]+s,t[1]+s),this.m_context.lineTo(t[0]+s,t[1]+s/2),this.m_context.lineTo(t[0]+s/2,t[1]+s/2),this.m_context.lineTo(t[0]+s/2,t[1])):13==this.m_type&&(this.m_context.moveTo(t[0],t[1]+s/2),this.m_context.lineTo(t[0],t[1]+s),this.m_context.lineTo(t[0]+s,t[1]+s),this.m_context.lineTo(t[0]+s,t[1]),this.m_context.lineTo(t[0]+s/2,t[1]),this.m_context.lineTo(t[0]+s/2,t[1]+s/2)),this.m_context.fill(),this.m_context.stroke(),this.m_context.restore()}}class d extends u{m_radius=0;m_is_move=!1;m_tfm=new c;m_stroke_width=0;m_move_color="";m_iddle_color="";m_stroke_clor="";m_is_stroke=!1;constructor(t,s){super(t,s)}set_move(t){this.m_is_move=t}set_position(t,s){this.m_tfm.set_translation(t,s)}set_rotation(t){this.m_tfm.set_rotation(t)}set_radius(t){this.m_radius=t}draw(){this.m_context.save(),this.m_context.lineWidth=this.m_stroke_width,this.m_context.fillStyle=this.m_is_move?this.m_move_color:this.m_iddle_color,this.m_context.strokeStyle=this.m_stroke_clor,this.m_context.beginPath();const t=this.m_wtc_tfm.compose_tfms(this.m_tfm),s=t.multiply(0,0),i=t.apply_scale(this.m_radius),e=t.multiply(this.m_radius*Math.SQRT2,0),_=this.m_tfm.rotation();this.m_context.arc(s[0],s[1],i,_+Math.PI/4,2*Math.PI+_-Math.PI/4),this.m_context.lineTo(e[0],e[1]),this.m_context.fill(),this.m_is_stroke&&this.m_context.stroke(),this.m_context.restore()}}class E extends d{constructor(t,s){super(t,s),this.m_stroke_width=1,this.m_move_color="rgba(91, 128, 78, 0.5)",this.m_iddle_color=l,this.m_stroke_clor="rgb(74, 193, 33)",this.m_is_stroke=false}}class T extends d{constructor(t,s){super(t,s),this.m_stroke_width=1,this.m_move_color="rgba(196, 94, 45, 0.5)",this.m_iddle_color="rgba(196, 94, 45, 0.75)",this.m_stroke_clor="rgb(226, 55, 27)",this.m_is_stroke=false}}class w extends u{m_active=!1;m_pos_x=0;m_pos_y=0;m_start_time=0;constructor(t,s){super(t,s)}activate(t,s){this.m_pos_x=t,this.m_pos_y=s,this.m_start_time=performance.now(),this.m_active=!0}draw(){if(this.m_active){const t=performance.now()-this.m_start_time,s=Math.pow(Math.min(t/400,1),.15);this.m_context.save(),this.m_context.lineWidth=1,this.m_context.fillStyle="rgba(232, 128, 51, 0.25)",this.m_context.strokeStyle=x,this.m_context.beginPath();const i=this.m_wtc_tfm.multiply(this.m_pos_x,this.m_pos_y),e=this.m_wtc_tfm.apply_scale(.5)*s;this.m_context.arc(i[0],i[1],e,0,2*Math.PI),this.m_context.fill(),this.m_context.stroke(),this.m_context.beginPath(),this.m_context.fillStyle=x,this.m_context.arc(i[0],i[1],2,0,2*Math.PI),this.m_context.fill(),this.m_context.restore(),t>400&&(this.m_active=!1)}}}class y extends u{m_active=!1;m_tfm=new c;m_scale=0;m_scale_index=0;constructor(t,s,i,e,_,m){super(t,s),this.m_canvas_width=t.canvas.width,this.m_canvas_height=t.canvas.height,this.m_tile_size=i,this.m_vertices=e,this.m_polygons=_,this.m_sizes=m,this.m_scale_index=Math.floor(r.length/2),this._update_scale()}_update_scale(){this.m_scale=r[this.m_scale_index]/this.m_tile_size}toggle_active(){this.m_active=!this.m_active}scale_up(){this.m_active&&(this.m_scale_index++,this.m_scale_index==r.length&&this.m_scale_index--,this._update_scale())}scale_down(){this.m_active&&(this.m_scale_index--,-1==this.m_scale_index&&this.m_scale_index++,this._update_scale())}draw(){if(this.m_active){const t=this.m_wtc_tfm.inverse().multiply(this.m_canvas_width/2,this.m_canvas_height/2);this.m_tfm.set_uniform_scale(this.m_scale),this.m_tfm.set_translation(this.m_canvas_width/2-t[0]*this.m_scale,this.m_canvas_height/2-t[1]*this.m_scale),this.m_context.save(),this.m_context.fillStyle=f,this.m_context.strokeStyle=f,this.m_context.lineWidth=.125;let s=0;for(let t=0;t<this.m_sizes.length;t++){const i=this.m_sizes[t];this.m_context.beginPath();for(let t=0;t<i;t++){const i=this.m_polygons[s+t],e=this.m_vertices[3*i],_=this.m_vertices[3*i+2],m=this.m_tfm.multiply(e,_);0==t?this.m_context.moveTo(m[0],m[1]):this.m_context.lineTo(m[0],m[1])}this.m_context.fill(),this.m_context.stroke(),s+=i}this.m_context.beginPath(),this.m_context.fillStyle=l;const i=this.m_tfm.multiply(t[0],t[1]);this.m_context.arc(i[0],i[1],2,0,2*Math.PI),this.m_context.fill(),this.m_context.restore()}}}class g{m_level_width=0;m_level_height=0;m_level_tile_size=0;m_last_click_time=0;m_click_number=0;m_level_tiles=new Map;m_wtc_scale=0;m_wtc_tfm=new c;m_monsters=new Map;m_monstars_total=0;m_camera_pos_x=0;m_camera_pos_y=0;m_fps_accumulator=0;m_fps_ticks=0;m_fps_value=0;constructor(t,s,i,e){this.m_context=t,this.m_canvas_width=s,this.m_canvas_height=i;let _=new Float32Array,m=new Int32Array,h=new Int32Array;var a=!1,n=0;const r=e.length;for(;!a;){const t=e[n],s=e[n+1];if(n+=2,s>0)if(t==o.LEVEL_WIDHT)this.m_level_width=e[n];else if(t==o.LEVEL_HEIGHT)this.m_level_height=e[n];else if(t==o.TILE_SIZE)this.m_level_tile_size=e[n];else if(t==o.NAVMESH_VERTICES){_=new Float32Array(s);for(let t=0;t<s;t++)_[t]=e[n+t]}else if(t==o.NAVMESH_POLYGONS){m=new Int32Array(s);for(let t=0;t<s;t++)m[t]=e[n+t]}else if(t==o.NAVMESH_SIZES){h=new Int32Array(s);for(let t=0;t<s;t++)h[t]=e[n+t]}else t==o.LEVEL_TOTAL_TILES&&console.log("Level tiles:",e[n]);(n+=s)>=r&&(a=!0)}this.m_wtc_tfm.set_translation(0,0),this.m_wtc_scale=50/this.m_level_tile_size,this.m_wtc_tfm.set_uniform_scale(this.m_wtc_scale),this.m_player=new E(this.m_context,this.m_wtc_tfm),this.m_click_cursor=new w(this.m_context,this.m_wtc_tfm),this.m_map=new y(this.m_context,this.m_wtc_tfm,this.m_level_tile_size,_,m,h)}reset_click(){this.m_click_number=0}click_position(t,s,i=!1){const e=performance.now();if(i||e-this.m_last_click_time>(1==this.m_click_number?500:30)){this.m_last_click_time=e,this.m_click_number+=1,this.m_click_number>2&&(this.m_click_number=2);const m=this.m_wtc_tfm.inverse().multiply(t,s),h=_(m[0],m[1]);i&&h&&this.m_click_cursor.activate(m[0],m[1])}}update_ui(){let t=document.getElementById("level_count");t&&(t.innerText=this.m_monstars_total.toString());let s=document.getElementById("visible_count");s&&(s.innerText=this.m_monsters.size.toString());let i=document.getElementById("fps");i&&(i.innerText=(Math.round(100*this.m_fps_value)/100).toFixed(2).toString())}press_key(t){"m"==t?this.m_map.toggle_active():"+"==t?this.m_map.scale_up():"-"==t&&this.m_map.scale_down()}draw_background(){this.m_context.clearRect(0,0,this.m_canvas_width,this.m_canvas_height),this.m_context.save(),this.m_context.fillStyle="rgb(64, 64, 64)",this.m_context.fillRect(0,0,this.m_canvas_width,this.m_canvas_height),this.m_context.restore()}draw(){this.draw_background();for(let[t,s]of this.m_level_tiles)s.draw();this.m_click_cursor.draw(),this.m_player.draw();for(let[t,s]of this.m_monsters)s.draw();this.m_map.draw()}update(t,s){for(var i=!1,e=0;!i;){const s=t[e],_=t[e+1];if(e+=2,_>0)if(s==o.PLAYER_POSITION){const s=t[e],i=t[e+1];this.m_player.set_position(s,i),this.m_camera_pos_x=1*s+0*this.m_camera_pos_x,this.m_camera_pos_y=1*i+0*this.m_camera_pos_y,this.m_wtc_tfm.set_translation(this.m_canvas_width/2-this.m_camera_pos_x*this.m_wtc_scale,this.m_canvas_height/2-this.m_camera_pos_y*this.m_wtc_scale)}else if(s==o.PLAYER_RADIUS){const s=t[e];this.m_player.set_radius(s)}else if(s==o.PLAYER_ANGLE){const s=t[e];this.m_player.set_rotation(s)}else if(s==o.PLAYER_MOVE){const s=t[e];this.m_player.set_move(s>.5)}else if(s==o.TILES_TO_DELETE)for(let s=0;s<_;s++){const i=t[e+s];this.m_level_tiles.has(i)&&this.m_level_tiles.delete(i)}else if(s==o.TILES_TO_CREATE){const s=_/4;for(let i=0;i<s;i++){const s=t[e+4*i],_=t[e+4*i+1],m=t[e+4*i+2],h=t[e+4*i+3];this.m_level_tiles.set(m,new p(this.m_context,this.m_wtc_tfm,s*this.m_level_tile_size,_*this.m_level_tile_size,this.m_level_tile_size,h))}}else if(s==o.MONSTERS_COUNT)this.m_monstars_total=t[e];else if(s==o.MONSTER_POSITION){const s=t[e],i=t[e+1],_=t[e+2];if(this.m_monsters.has(s)){const t=this.m_monsters.get(s);t&&t.set_position(i,_)}else{let t=new T(this.m_context,this.m_wtc_tfm);t.set_position(i,_),this.m_monsters.set(s,t)}}else if(s==o.MONSTER_RADIUS){const s=t[e],i=t[e+1];if(this.m_monsters.has(s)){const t=this.m_monsters.get(s);t&&t.set_radius(i)}else this.m_monsters.set(s,new T(this.m_context,this.m_wtc_tfm))}else if(s==o.MONSTER_ANGLE){const s=t[e],i=t[e+1];if(this.m_monsters.has(s)){const t=this.m_monsters.get(s);t&&t.set_rotation(i)}else this.m_monsters.set(s,new T(this.m_context,this.m_wtc_tfm))}else if(s==o.MONSTER_MOVE){const s=t[e],i=t[e+1]>.5;if(this.m_monsters.has(s)){const t=this.m_monsters.get(s);t&&t.set_move(i)}else this.m_monsters.set(s,new T(this.m_context,this.m_wtc_tfm))}else if(s==o.MONSTERS_TO_DELETE)for(let s=0;s<_;s++){const i=t[e+s];this.m_monsters.has(i)&&this.m_monsters.delete(i)}(e+=_)>=t.length&&(i=!0)}this.m_fps_accumulator+=s,this.m_fps_ticks+=1,this.draw(),this.update_ui(),this.m_fps_accumulator>2&&(this.m_fps_value=this.m_fps_ticks/this.m_fps_accumulator,this.m_fps_accumulator=0,this.m_fps_ticks=0)}}const v=document.getElementById("canvas");var S=!1,L=null;function O(t,s){const i=t.getBoundingClientRect();return[s.clientX-i.left,s.clientY-i.top]}if(v){const t=v.getContext("2d");var I=performance.now();const s=Math.floor(4294967295*Math.random());console.log("use seed "+s),i(s),console.log("generate level time:",(performance.now()-I)/1e3,"seconds");var M=document.getElementById("loading");M&&(M.hidden=!0);var A=m(),R=new g(t,v.width,v.height,A);v.addEventListener("mousedown",(function(t){S=!0;const s=O(v,L=t);R.click_position(s[0],s[1],!0)})),v.addEventListener("mouseup",(function(t){S=!1,R.reset_click()})),document.onmousemove=function(t){L=t},document.onkeydown=function(t){const s=t.key;"s"==s?e():R.press_key(s)},function t(){if(S&&L&&v){const t=O(v,L);R.click_position(t[0],t[1])}const s=performance.now(),i=(s-I)/1e3;I=s,h(i);var e=a();R.update(e,i),window.requestAnimationFrame(t)}()}
//# sourceMappingURL=module.js.map
