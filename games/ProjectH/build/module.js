async function t(t,e={}){const _={env:Object.assign(Object.create(globalThis),e.env||{},{abort(t,e,_,s){t=n(t>>>0),e=n(e>>>0),_>>>=0,s>>>=0,(()=>{throw Error(`${t} in ${e}:${_}:${s}`)})()},"host.entity_resurrect"(t,e,_){t>>>=0,e>>>=0,_>>>=0,host.entity_resurrect(t,e,_)},"host.update_entity_params"(t,e,_,s,i,a,n,h,r){t>>>=0,e=0!=e,_>>>=0,s>>>=0,host.update_entity_params(t,e,_,s,i,a,n,h,r)},"host.define_level"(t,e,_){t>>>=0,e>>>=0,host.define_level(t,e,_)},"host.define_total_tiles"(t){t>>>=0,host.define_total_tiles(t)},"host.define_navmesh"(t,e,_){t=h(b,2,t>>>0),e=h(p,2,e>>>0),_=h(p,2,_>>>0),host.define_navmesh(t,e,_)},"host.create_player"(t,e,_,s,i){t>>>=0,host.create_player(t,e,_,s,i)},"host.define_person_changes"(t,e,_,s,i,a,n,h,r,m){t>>>=0,i>>>=0,a>>>=0,n>>>=0,m=0!=m,host.define_person_changes(t,e,_,s,i,a,n,h,r,m)},"host.entity_finish_melee_attack"(t,e){t>>>=0,e=0!=e,host.entity_finish_melee_attack(t,e)},"host.entity_finish_hand_attack"(t,e){t>>>=0,e=0!=e,host.entity_finish_hand_attack(t,e)},"host.entity_finish_range_attack"(t,e){t>>>=0,e=0!=e,host.entity_finish_range_attack(t,e)},"host.entity_finish_hide"(t,e){t>>>=0,e=0!=e,host.entity_finish_hide(t,e)},"host.entity_finish_shadow_attack"(t,e){t>>>=0,e=0!=e,host.entity_finish_shadow_attack(t,e)},"host.entity_finish_skill"(t,e,_){t>>>=0,e>>>=0,_=0!=_,host.entity_finish_skill(t,e,_)},"host.entity_release_shield"(t){t>>>=0,host.entity_release_shield(t)},"host.entity_start_shadow_attack"(t,e,_){t>>>=0,host.entity_start_shadow_attack(t,e,_)},"host.entity_start_cooldawn"(t,e,_){t>>>=0,e>>>=0,host.entity_start_cooldawn(t,e,_)},"host.entity_start_melee_attack"(t,e,_,s){t>>>=0,host.entity_start_melee_attack(t,e,_,s)},"host.entity_start_range_attack"(t,e){t>>>=0,host.entity_start_range_attack(t,e)},"host.entity_start_hand_attack"(t,e,_){t>>>=0,host.entity_start_hand_attack(t,e,_)},"host.entity_switch_hide"(t,e){t>>>=0,e=0!=e,host.entity_switch_hide(t,e)},"host.entity_start_skill_stun_cone"(t,e,_,s){t>>>=0,host.entity_start_skill_stun_cone(t,e,_,s)},"host.click_entity"(t,e){t>>>=0,e>>>=0,host.click_entity(t,e)},"host.click_position"(t,e){host.click_position(t,e)},"host.entity_start_shift"(t){t>>>=0,host.entity_start_shift(t)},"host.entity_activate_shield"(t){t>>>=0,host.entity_activate_shield(t)},"host.entity_start_hide"(t,e){t>>>=0,host.entity_start_hide(t,e)},"host.entity_start_skill_round_attack"(t,e,_){t>>>=0,host.entity_start_skill_round_attack(t,e,_)},"host.entity_start_stun"(t,e){t>>>=0,host.entity_start_stun(t,e)},"host.define_total_update_entities"(t){t>>>=0,host.define_total_update_entities(t)},"host.define_bullet_changes"(t,e,_,s){t>>>=0,host.define_bullet_changes(t,e,_,s)},"host.debug_entity_walk_path"(t,e){t>>>=0,e=h(b,2,e>>>0),host.debug_entity_walk_path(t,e)},"host.debug_close_entity"(t,e,_,s,i,a){t>>>=0,s>>>=0,host.debug_close_entity(t,e,_,s,i,a)},"host.debug_visible_quad"(t,e,_,s){host.debug_visible_quad(t,e,_,s)},"host.debug_neighbourhood_quad"(t,e,_,s){host.debug_neighbourhood_quad(t,e,_,s)},"host.debug_search_quad"(t,e,_,s){host.debug_search_quad(t,e,_,s)},"host.debug_mid_quad"(t,e,_,s){host.debug_mid_quad(t,e,_,s)},"host.debug_enemies_list"(t,e,_){t>>>=0,_=h((t=>f(t)>>>0),2,_>>>0),host.debug_enemies_list(t,e,_)},"host.tile_delete"(t){t>>>=0,host.tile_delete(t)},"host.tile_create"(t,e,_,s){t>>>=0,e>>>=0,_>>>=0,s>>>=0,host.tile_create(t,e,_,s)},"host.remove_entity"(t,e,_){t>>>=0,e>>>=0,_>>>=0,host.remove_entity(t,e,_)},"host.create_monster"(t,e,_,s,i,a,n,h){t>>>=0,host.create_monster(t,e,_,s,i,a,n,h)},"host.create_bullet"(t,e,_,s,i,a,n){t>>>=0,n>>>=0,host.create_bullet(t,e,_,s,i,a,n)},"host.entity_finish_shift"(t){t>>>=0,host.entity_finish_shift(t)},"host.entity_finish_stun"(t){t>>>=0,host.entity_finish_stun(t)},"host.entity_damaged"(t,e,_,s){t>>>=0,e>>>=0,_>>>=0,s>>>=0,host.entity_damaged(t,e,_,s)},"host.entity_dead"(t){t>>>=0,host.entity_dead(t)}})},{exports:s}=await WebAssembly.instantiate(t,_),i=s.memory||e.env.memory,a=Object.setPrototypeOf({create_settings:()=>c(s.create_settings()>>>0),settings_set_seed(t,e){t=l(t)||g(),s.settings_set_seed(t,e)},settings_set_generate(t,e,_,i,a){t=l(t)||g(),s.settings_set_generate(t,e,_,i,a)},settings_set_use_debug(t,e){t=l(t)||g(),e=e?1:0,s.settings_set_use_debug(t,e)},settings_set_debug_flags(t,e,_,i,a,n,h,r){t=l(t)||g(),e=e?1:0,_=_?1:0,i=i?1:0,a=a?1:0,n=n?1:0,h=h?1:0,r=r?1:0,s.settings_set_debug_flags(t,e,_,i,a,n,h,r)},settings_set_neighbourhood_quad_size(t,e){t=l(t)||g(),s.settings_set_neighbourhood_quad_size(t,e)},settings_set_visible_quad_size(t,e){t=l(t)||g(),s.settings_set_visible_quad_size(t,e)},settings_set_search_quad_size(t,e){t=l(t)||g(),s.settings_set_search_quad_size(t,e)},settings_set_mid_quad_size(t,e){t=l(t)||g(),s.settings_set_mid_quad_size(t,e)},settings_set_rvo_time_horizon(t,e){t=l(t)||g(),s.settings_set_rvo_time_horizon(t,e)},settings_set_use_rvo(t,e){t=l(t)||g(),e=e?1:0,s.settings_set_use_rvo(t,e)},settings_set_snap_to_navmesh(t,e){t=l(t)||g(),e=e?1:0,s.settings_set_snap_to_navmesh(t,e)},settings_set_velocity_boundary_control(t,e){t=l(t)||g(),e=e?1:0,s.settings_set_velocity_boundary_control(t,e)},settings_set_path_recalculate_time(t,e,_){t=l(t)||g(),s.settings_set_path_recalculate_time(t,e,_)},settings_set_tiles_visible_radius(t,e){t=l(t)||g(),s.settings_set_tiles_visible_radius(t,e)},settings_set_search_system_chunk_count(t,e){t=l(t)||g(),s.settings_set_search_system_chunk_count(t,e)},settings_set_monster_iddle_time(t,e,_){t=l(t)||g(),s.settings_set_monster_iddle_time(t,e,_)},settings_set_monsters_per_room(t,e,_){t=l(t)||g(),s.settings_set_monsters_per_room(t,e,_)},settings_set_select_radius_delta(t,e){t=l(t)||g(),s.settings_set_select_radius_delta(t,e)},settings_set_level_tile_size(t,e){t=l(t)||g(),s.settings_set_level_tile_size(t,e)},settings_set_monster_random_walk_radius(t,e){t=l(t)||g(),s.settings_set_monster_random_walk_radius(t,e)},settings_set_bullet_max_distance(t,e){t=l(t)||g(),s.settings_set_bullet_max_distance(t,e)},settings_set_react_attack(t,e){t=l(t)||g(),e=e?1:0,s.settings_set_react_attack(t,e)},settings_set_default_monster_common(t,e,_,i,a,n){t=l(t)||g(),s.settings_set_default_monster_common(t,e,_,i,a,n)},settings_set_default_monster_person(t,e,_,i,a,n,h){t=l(t)||g(),s.settings_set_default_monster_person(t,e,_,i,a,n,h)},settings_set_player(t,e,_,i,a,n,h,r,m,c,o,d,u){t=l(t)||g(),s.settings_set_player(t,e,_,i,a,n,h,r,m,c,o,d,u)},settings_set_default_monster_weapon(t,e,_,i,a,n,h){t=l(t)||g(),s.settings_set_default_monster_weapon(t,e,_,i,a,n,h)},settings_set_default_empty_weapon(t,e,_,i,a,n,h){t=l(t)||g(),s.settings_set_default_empty_weapon(t,e,_,i,a,n,h)},settings_set_default_shadow_weapon(t,e,_,i,a){t=l(t)||g(),s.settings_set_default_shadow_weapon(t,e,_,i,a)},settings_set_skill_round_attack(t,e,_,i,a){t=l(t)||g(),s.settings_set_skill_round_attack(t,e,_,i,a)},settings_set_skill_stun_cone(t,e,_,i,a,n,h,r){t=l(t)||g(),s.settings_set_skill_stun_cone(t,e,_,i,a,n,h,r)},dev_game_resurrect_player(t){t=l(t)||g(),s.dev_game_resurrect_player(t)},dev_game_spawn_monster(t,e,_,i,a,n,h,r,m,c,o){t=d(l(t)||g()),h=l(h)||g(),o=o?1:0;try{s.dev_game_spawn_monster(t,e,_,i,a,n,h,r,m,c,o)}finally{u(t)}},dev_game_move_entity(t,e,_,i){t=l(t)||g(),s.dev_game_move_entity(t,e,_,i)},dev_add_sword_to_player(t,e,_,i,a,n,h,r){t=l(t)||g(),s.dev_add_sword_to_player(t,e,_,i,a,n,h,r)},dev_add_bow_to_player(t,e,_,i,a,n,h){t=l(t)||g(),s.dev_add_bow_to_player(t,e,_,i,a,n,h)},dev_player_equip_sword(t){t=l(t)||g(),s.dev_player_equip_sword(t)},dev_player_equip_bow(t){t=l(t)||g(),s.dev_player_equip_bow(t)},dev_player_equip_free_hands(t){t=l(t)||g(),s.dev_player_equip_free_hands(t)},dev_create_virtual_sword:(t,e,_,i,a,n,h,r)=>(t=l(t)||g(),c(s.dev_create_virtual_sword(t,e,_,i,a,n,h,r)>>>0)),dev_create_virtual_bow:(t,e,_,i,a,n,h)=>(t=l(t)||g(),c(s.dev_create_virtual_bow(t,e,_,i,a,n,h)>>>0)),dev_create_virtual_empty_weapon:(t,e,_,i,a,n,h)=>(t=l(t)||g(),c(s.dev_create_virtual_empty_weapon(t,e,_,i,a,n,h)>>>0)),create_game:t=>(t=l(t)||g(),c(s.create_game(t)>>>0)),game_update(t,e){t=l(t)||g(),s.game_update(t,e)},game_client_point(t,e,_){t=l(t)||g(),s.game_client_point(t,e,_)},game_client_shift(t,e,_){t=l(t)||g(),s.game_client_shift(t,e,_)},game_client_shield(t){t=l(t)||g(),s.game_client_shield(t)},game_client_release_shield(t){t=l(t)||g(),s.game_client_release_shield(t)},game_client_toggle_hide(t){t=l(t)||g(),s.game_client_toggle_hide(t)},game_skill_nontarget:(t,e)=>(t=l(t)||g(),0!=s.game_skill_nontarget(t,e)),game_skill_target:(t,e,_,i)=>(t=l(t)||g(),0!=s.game_skill_target(t,e,_,i)),game_add_monsters(t){t=l(t)||g(),s.game_add_monsters(t)},game_make_aggressive(t){t=l(t)||g(),s.game_make_aggressive(t)},game_damage_all_entities(t,e){t=l(t)||g(),s.game_damage_all_entities(t,e)},game_stun_all_entities(t,e){t=l(t)||g(),s.game_stun_all_entities(t,e)}},s);function n(t){if(!t)return null;const e=t+new Uint32Array(i.buffer)[t-4>>>2]>>>1,_=new Uint16Array(i.buffer);let s=t>>>1,a="";for(;e-s>1024;)a+=String.fromCharCode(..._.subarray(s,s+=1024));return a+String.fromCharCode(..._.subarray(s,e))}function h(t,e,_){if(!_)return null;const s=f(_-4)>>>e,i=new Array(s);for(let a=0;a<s;++a)i[a]=t(_+(a<<e>>>0));return i}class r extends Number{}const m=new FinalizationRegistry(u);function c(t){if(!t)return null;const e=new r(d(t));return m.register(e,t),e}function l(t){if(null==t)return 0;if(t instanceof r)return t.valueOf();throw TypeError("internref expected")}const o=new Map;function d(t){if(t){const e=o.get(t);e?o.set(t,e+1):o.set(s.__pin(t),1)}return t}function u(t){if(t){const e=o.get(t);if(1===e)s.__unpin(t),o.delete(t);else{if(!e)throw Error(`invalid refcount '${e}' for reference '${t}'`);o.set(t,e-1)}}}function g(){throw TypeError("value must not be null")}let y=new DataView(i.buffer);function p(t){try{return y.getInt32(t,!0)}catch{return y=new DataView(i.buffer),y.getInt32(t,!0)}}function f(t){try{return y.getUint32(t,!0)}catch{return y=new DataView(i.buffer),y.getUint32(t,!0)}}function b(t){try{return y.getFloat32(t,!0)}catch{return y=new DataView(i.buffer),y.getFloat32(t,!0)}}return a}const e=[3,5,8,12,15,20,30,40,50];let _;var s;let i;var a;let n;var h;let r;var m;let c;var l;let o;var d;let u;var g;let y;var p;let f;var b;(s=_||(_={}))[s.MELEE_ATTACK=0]="MELEE_ATTACK",s[s.RANGE_ATTACK=1]="RANGE_ATTACK",s[s.HAND_ATTACK=2]="HAND_ATTACK",s[s.STUN=3]="STUN",s[s.HIDE_ACTIVATION=4]="HIDE_ACTIVATION",s[s.SHADOW_ATTACK=5]="SHADOW_ATTACK",s[s.SKILL_ROUND_ATTACK=6]="SKILL_ROUND_ATTACK",s[s.SKILL_STUN_CONE=7]="SKILL_STUN_CONE",(a=i||(i={}))[a.PLAYER=0]="PLAYER",a[a.MONSTER=1]="MONSTER",a[a.BULLET=2]="BULLET",(h=n||(n={}))[h.ARROW=0]="ARROW",(m=r||(r={}))[m.VISIBILITY_OUT=0]="VISIBILITY_OUT",m[m.COME_TARGET=1]="COME_TARGET",m[m.DAMAGE_ELIMINATE=2]="DAMAGE_ELIMINATE",(l=c||(c={}))[l.NONE=0]="NONE",l[l.WALK=1]="WALK",l[l.SHIFT=2]="SHIFT",(d=o||(o={}))[d.NONE=0]="NONE",d[d.ATTACK=1]="ATTACK",d[d.SKILL_ENTITY=2]="SKILL_ENTITY",d[d.SKILL_POSITION=3]="SKILL_POSITION",(g=u||(u={}))[g.SHIFT=0]="SHIFT",g[g.HAND_ATTACK=1]="HAND_ATTACK",g[g.MELEE_ATTACK=2]="MELEE_ATTACK",g[g.RANGE_ATTACK=3]="RANGE_ATTACK",g[g.HIDE_ACTIVATION=4]="HIDE_ACTIVATION",g[g.SHADOW_ATTACK=5]="SHADOW_ATTACK",g[g.SKILL_ROUND_ATTACK=6]="SKILL_ROUND_ATTACK",g[g.SKILL_STUN_CONE=7]="SKILL_STUN_CONE",(p=y||(y={}))[p.UNKNOWN=0]="UNKNOWN",p[p.MELEE=1]="MELEE",p[p.RANGE=2]="RANGE",p[p.ULTIMATE=3]="ULTIMATE",(b=f||(f={}))[b.NONE=0]="NONE",b[b.ROUND_ATTACK=1]="ROUND_ATTACK",b[b.STUN_CONE=2]="STUN_CONE";class v{m_matrix=new Float32Array(9);m_angle=0;m_scale_x=1;m_scale_y=1;constructor(){this.m_matrix[0]=1,this.m_matrix[1]=0,this.m_matrix[2]=0,this.m_matrix[3]=0,this.m_matrix[4]=1,this.m_matrix[5]=0,this.m_matrix[6]=0,this.m_matrix[7]=0,this.m_matrix[8]=1}matrix_array(){return this.m_matrix}set_matrix_array(t){for(let e=0;e<9;e++)this.m_matrix[e]=t[e]}set_translation(t,e){this.m_matrix[2]=t,this.m_matrix[5]=e}translation(){return[this.m_matrix[2],this.m_matrix[5]]}_update_rotation(){this.m_matrix[0]=Math.cos(this.m_angle)*this.m_scale_x,this.m_matrix[3]=Math.sin(this.m_angle)*this.m_scale_x,this.m_matrix[1]=-Math.sin(this.m_angle)*this.m_scale_y,this.m_matrix[4]=Math.cos(this.m_angle)*this.m_scale_y}set_rotation(t){this.m_angle=t,this._update_rotation()}rotation(){return this.m_angle}uniform_scale(){return(this.m_scale_x+this.m_scale_y)/2}scale(){return[this.m_scale_x,this.m_scale_y]}set_scale(t,e){this.m_scale_x=t,this.m_scale_y=e,this._update_rotation()}set_uniform_scale(t){this.m_scale_x=t,this.m_scale_y=t,this._update_rotation()}multiply(t,e){return[this.m_matrix[0]*t+this.m_matrix[1]*e+this.m_matrix[2],this.m_matrix[3]*t+this.m_matrix[4]*e+this.m_matrix[5]]}multiply_array(t){return this.multiply(t[0],t[1])}apply_scale(t){return t*(Math.sqrt(this.m_matrix[0]*this.m_matrix[0]+this.m_matrix[3]*this.m_matrix[3])+Math.sqrt(this.m_matrix[1]*this.m_matrix[1]+this.m_matrix[4]*this.m_matrix[4]))/2}compose_tfms(t){let e=new v;const _=this.matrix_array(),s=t.matrix_array();let i=[_[0]*s[0]+_[1]*s[3]+_[2]*s[6],_[0]*s[1]+_[1]*s[4]+_[2]*s[7],_[0]*s[2]+_[1]*s[5]+_[2]*s[8],_[3]*s[0]+_[4]*s[3]+_[5]*s[6],_[3]*s[1]+_[4]*s[4]+_[5]*s[7],_[3]*s[2]+_[4]*s[5]+_[5]*s[8],_[6]*s[0]+_[7]*s[3]+_[8]*s[6],_[6]*s[1]+_[7]*s[4]+_[8]*s[7],_[6]*s[2]+_[7]*s[5]+_[8]*s[8]];return e.set_matrix_array(i),e}_det2(t,e,_,s){return t*s-e*_}inverse(){const t=this.m_matrix[0]*this.m_matrix[4]*this.m_matrix[8]+this.m_matrix[2]*this.m_matrix[3]*this.m_matrix[7]+this.m_matrix[1]*this.m_matrix[5]*this.m_matrix[6]-this.m_matrix[2]*this.m_matrix[4]*this.m_matrix[6]-this.m_matrix[0]*this.m_matrix[5]*this.m_matrix[7]-this.m_matrix[1]*this.m_matrix[3]*this.m_matrix[8],e=[this._det2(this.m_matrix[4],this.m_matrix[5],this.m_matrix[7],this.m_matrix[8])/t,-1*this._det2(this.m_matrix[1],this.m_matrix[2],this.m_matrix[7],this.m_matrix[8])/t,this._det2(this.m_matrix[1],this.m_matrix[2],this.m_matrix[4],this.m_matrix[5])/t,-1*this._det2(this.m_matrix[3],this.m_matrix[5],this.m_matrix[6],this.m_matrix[8])/t,this._det2(this.m_matrix[0],this.m_matrix[2],this.m_matrix[6],this.m_matrix[8])/t,-1*this._det2(this.m_matrix[0],this.m_matrix[2],this.m_matrix[3],this.m_matrix[5])/t,this._det2(this.m_matrix[3],this.m_matrix[4],this.m_matrix[6],this.m_matrix[7])/t,-1*this._det2(this.m_matrix[0],this.m_matrix[1],this.m_matrix[6],this.m_matrix[7])/t,this._det2(this.m_matrix[0],this.m_matrix[1],this.m_matrix[3],this.m_matrix[4])/t];let _=new v;return _.set_matrix_array(e),_}toString(){let t="";return t+=this.m_matrix[0]+", "+this.m_matrix[1]+", "+this.m_matrix[2]+"\n",t+=this.m_matrix[3]+", "+this.m_matrix[4]+", "+this.m_matrix[5]+"\n",t+=this.m_matrix[6]+", "+this.m_matrix[7]+", "+this.m_matrix[8],t}}const w="rgba(91, 128, 78, 0.75)",k="rgba(145, 145, 145, 0.25)",T="rgba(234, 112, 23, 0.5)",x="rgba(48, 148, 233, 0.5)",A="rgba(217, 43, 20, 0.5)";class E{m_active=!1;m_tfm=new v;m_scale=0;m_scale_index=0;constructor(t,_,s,i,a,n){this.m_context=t,this.m_wtc_tfm=_,this.m_canvas_width=t.canvas.width,this.m_canvas_height=t.canvas.height,this.m_tile_size=s,this.m_vertices=i,this.m_polygons=a,this.m_sizes=n,this.m_scale_index=Math.floor(e.length/2),this._update_scale()}_update_scale(){this.m_scale=e[this.m_scale_index]/this.m_tile_size}toggle_active(){this.m_active=!this.m_active}scale_up(){this.m_active&&(this.m_scale_index++,this.m_scale_index==e.length&&this.m_scale_index--,this._update_scale())}scale_down(){this.m_active&&(this.m_scale_index--,-1==this.m_scale_index&&this.m_scale_index++,this._update_scale())}draw(){if(this.m_context.clearRect(0,0,this.m_canvas_width,this.m_canvas_height),this.m_active){const t=this.m_wtc_tfm.inverse().multiply(this.m_canvas_width/2,this.m_canvas_height/2);this.m_tfm.set_uniform_scale(this.m_scale),this.m_tfm.set_translation(this.m_canvas_width/2-t[0]*this.m_scale,this.m_canvas_height/2-t[1]*this.m_scale),this.m_context.save(),this.m_context.fillStyle=x,this.m_context.strokeStyle=x,this.m_context.lineWidth=.125;let e=0;for(let t=0;t<this.m_sizes.length;t++){const _=this.m_sizes[t];this.m_context.beginPath();for(let t=0;t<_;t++){const _=this.m_polygons[e+t],s=this.m_vertices[3*_],i=this.m_vertices[3*_+2],a=this.m_tfm.multiply(s,i);0==t?this.m_context.moveTo(a[0],a[1]):this.m_context.lineTo(a[0],a[1])}this.m_context.fill(),this.m_context.stroke(),e+=_}this.m_context.beginPath(),this.m_context.fillStyle=w;const _=this.m_tfm.multiply(t[0],t[1]);this.m_context.arc(_[0],_[1],2,0,2*Math.PI),this.m_context.fill(),this.m_context.restore()}}}class N{m_tfm=new v;m_debug_draw=!1;constructor(){}set_debug_draw(t){this.m_debug_draw=t}set_position(t,e){this.m_tfm.set_translation(t,e)}set_angle(t){this.m_tfm.set_rotation(t)}get_debug_draw(){return this.m_debug_draw}get_tfm(){return this.m_tfm}get_translation(){return this.m_tfm.translation()}}class I extends N{m_entity_id=-1;constructor(t){super(),this.m_entity_id=t}get_id(){return this.m_entity_id}set_id(t){this.m_entity_id=t}}let S;var M;(M=S||(S={}))[M.NONE=0]="NONE",M[M.POSITION=1]="POSITION",M[M.ENEMY_ENTITY=2]="ENEMY_ENTITY";class P extends N{m_active=!1;m_charge=!1;m_time_accum=0;m_life_time=0;m_type=S.NONE;m_select_person=null;m_remember_last_select=!1;m_remember_id=0;constructor(t){super(),this.m_life_time=400,this.m_parent_scene=t}charge(){this.m_charge=!0}is_charge(){return this.m_charge}activate_by_position(t,e){this.m_tfm.set_translation(t,e),this.m_time_accum=0,this.m_active=!0,this.m_charge=!1,this.m_type=S.POSITION,this.m_remember_last_select=!1,this.m_remember_id=0}activate_by_entity_remember(t){this.m_remember_last_select&&this.m_remember_id==t&&this.activate_by_enemy_select(t)}activate_by_enemy_select(t){this.m_time_accum=0,this.m_select_person=this.m_parent_scene.get_person(t),this.m_select_person?(this.m_active=!0,this.m_charge=!1,this.m_type=S.ENEMY_ENTITY,this._define_tfm_for_selection(),this.m_remember_last_select=!1,this.m_remember_id=0):(this.m_remember_last_select=!0,this.m_remember_id=t)}get_type(){return this.m_type}get_active(){return this.m_active}get_translation(){return this.m_tfm.translation()}get_size(){return this.m_tfm.uniform_scale()}_define_tfm_for_selection(){if(this.m_type==S.ENEMY_ENTITY&&this.m_select_person){const t=this.m_select_person.get_tfm().translation();this.m_tfm.set_translation(t[0],t[1]),this.m_tfm.set_uniform_scale(this.m_select_person.get_select_radius())}}update(t){this.m_active&&(this.m_type==S.ENEMY_ENTITY&&this._define_tfm_for_selection(),this.m_time_accum+=1e3*t,this.m_type==S.POSITION&&this.m_time_accum>=this.m_life_time&&this.deactivate())}get_proportion(){return this.m_time_accum/this.m_life_time}get_entity_select(){return this.m_type==S.ENEMY_ENTITY?this.m_select_person:null}deactivate_by_entity_remove(t,e){this.m_type==S.ENEMY_ENTITY&&this.m_select_person&&this.m_select_person.get_id()==t&&(this.deactivate_enemy_select(),e||(this.m_remember_last_select=!0,this.m_remember_id=t))}deactivate_enemy_select(){this.m_type==S.ENEMY_ENTITY&&this.deactivate()}deactivate(){this.m_active=!1,this.m_charge=!1,this.m_type=S.NONE,this.m_select_person=null,this.m_remember_last_select=!1,this.m_remember_id=0}}class O extends N{m_tile_size=0;m_type=1;constructor(t,e,_,s){super(),this.set_position(t,e),this.m_tile_size=_,this.m_type=s}get_tile_size(){return this.m_tile_size}get_type(){return this.m_type}}class C extends I{m_radius=0;m_attack_distance=0;m_life=0;m_max_life=0;m_shield=0;m_max_shield=0;m_move_status=c.NONE;m_is_dead=!1;m_select_radius=0;m_search_radius=0;m_search_spread=0;m_active_shield=!1;m_is_hide=!1;m_is_visible_search_cone=!1;constructor(t){super(t)}set_team(t){this.m_team=t}set_is_dead(t){this.m_is_dead=t}set_alive(){this.m_is_dead=!1}get_is_dead(){return this.m_is_dead}set_radius(t){this.m_radius=t}set_search_radius(t){this.m_search_radius=t}set_search_spread(t){this.m_search_spread=t}set_attack_distance(t){this.m_attack_distance=t}set_life(t,e){this.m_life=t,this.m_max_life=e}set_active_shield(t){this.m_active_shield=t}set_shield(t,e){this.m_shield=t,this.m_max_shield=e}set_select_radius(t){this.m_select_radius=t}set_move(t){this.m_move_status=t}set_is_hide(t){this.m_is_hide=t}set_visible_search_cone(t){this.m_is_visible_search_cone=t}get_move(){return this.m_move_status}get_radius(){return this.m_radius}get_attack_distance(){return this.m_attack_distance}get_life(){return this.m_life}get_max_life(){return this.m_max_life}get_life_proportion(){return this.m_life/this.m_max_life}get_shield(){return this.m_shield}get_max_shield(){return this.m_max_shield}get_shield_proportion(){return this.m_shield/this.m_max_shield}get_shield_active(){return this.m_active_shield}get_select_radius(){return this.m_select_radius}get_search_radius(){return this.m_search_radius}get_search_spread(){return this.m_search_spread}get_is_hide(){return this.m_is_hide}get_is_visible_search_cone(){return this.m_is_visible_search_cone}}class L extends C{constructor(t){super(t)}}class K extends C{constructor(t){super(t)}}class z{m_cooldawns=new Map;add_entity(t){this.m_cooldawns.set(t,new Map)}remove_entity(t){this.m_cooldawns.delete(t)}start_cooldawn(t,e,_){this.m_cooldawns.get(t)?.set(e,[_,0])}update(t){this.m_cooldawns.forEach(((e,_)=>{e.forEach(((_,s)=>{_[1]+=t,_[1]>=_[0]&&e.delete(s)}))}))}get_cooldawns(t){const e=this.m_cooldawns.get(t);return e||new Map}}class q{m_effects=new Map;add_effect(t,e){this.m_effects.has(t)||this.m_effects.set(t,new Array);const _=this.m_effects.get(t);_&&_.push(e)}remove_by_type(t,e){const _=this.m_effects.get(t);if(_){let t=_.length-1;for(;t>=0;){_[t].type()==e&&_.splice(t,1),t--}}}add_melee_attack(t,e,_,s){this.add_effect(t,new R(e,_,s))}add_range_attack(t,e){this.add_effect(t,new U(e))}add_hand_attack(t,e,_){this.add_effect(t,new W(e,_))}add_shadow_attack(t,e,_){this.add_effect(t,new H(e,_))}add_stun(t,e){this.add_effect(t,new Y(e))}add_hide_cast(t,e){this.add_effect(t,new F(e))}add_skill_round_attack(t,e,_){this.add_effect(t,new G(e,_))}add_skill_stun_cone(t,e,_,s){this.add_effect(t,new V(e,_,s))}remove_melee_attack(t){this.remove_by_type(t,_.MELEE_ATTACK)}remove_range_attack(t){this.remove_by_type(t,_.RANGE_ATTACK)}remove_hand_attack(t){this.remove_by_type(t,_.HAND_ATTACK)}remove_shadow_attack(t){this.remove_by_type(t,_.SHADOW_ATTACK)}remove_skill(t,e){e==f.ROUND_ATTACK?this.remove_by_type(t,_.SKILL_ROUND_ATTACK):e==f.STUN_CONE&&this.remove_by_type(t,_.SKILL_STUN_CONE)}remove_stun(t){this.remove_by_type(t,_.STUN)}remove_hide_cast(t){this.remove_by_type(t,_.HIDE_ACTIVATION)}update(t){for(const[e,_]of this.m_effects){let e=_.length-1;for(;e>=0;){_[e].update(t)||_.splice(e,1),e--}}}get_entity_effects(t){const e=this.m_effects.get(t);return e||[]}}class D{constructor(t,e){this.m_total_time=t,this.m_spend_time=0,this.m_type=e}update(t){return this.m_spend_time+=t,!(this.m_total_time<=this.m_spend_time)}type(){return this.m_type}proportion(){return this.m_spend_time/this.m_total_time}}class R extends D{constructor(t,e,s){super(t,_.MELEE_ATTACK),this.m_distance=e,this.m_spread=s}distance(){return this.m_distance}spread(){return this.m_spread}}class U extends D{constructor(t){super(t,_.RANGE_ATTACK)}}class W extends D{constructor(t,e){super(t,_.HAND_ATTACK),this.m_distance=e}distance(){return this.m_distance}}class H extends D{constructor(t,e){super(t,_.SHADOW_ATTACK),this.m_distance=e}distance(){return this.m_distance}}class Y extends D{constructor(t){super(t,_.STUN)}}class F extends D{constructor(t){super(t,_.HIDE_ACTIVATION)}}class G extends D{constructor(t,e){super(t,_.SKILL_ROUND_ATTACK),this.m_area_size=e}area_size(){return this.m_area_size}}class V extends D{constructor(t,e,s){super(t,_.SKILL_STUN_CONE),this.m_cone_spread=e,this.m_cone_size=s}cone_spread(){return this.m_cone_spread}cone_size(){return this.m_cone_size}}class B extends I{m_debug_target_x=0;m_debug_target_y=0;constructor(t,e){super(t),this.m_type=e}set_debug_target(t,e){this.m_debug_target_x=t,this.m_debug_target_y=e}get_type(){return this.m_type}get_debug_target_x(){return this.m_debug_target_x}get_debug_target_y(){return this.m_debug_target_y}}class j{m_level_width=0;m_level_height=0;m_level_tile_size=0;m_last_click_time=0;m_click_number=0;m_click_cursor=new P(this);m_level_tiles=new Map;m_player=new L(0);m_player_id=0;m_monsters=new Map;m_bullets=new Map;m_cooldawns=new z;m_effects=new q;m_visible_search_cones=!1;constructor(t,e,_){this.m_level_width=t,this.m_level_height=e,this.m_level_tile_size=_}update(t){this.m_cooldawns.update(t),this.m_effects.update(t),this.m_click_cursor.update(t)}input_click(t,e,_,s,i){const a=performance.now();return!!(i||a-this.m_last_click_time>(1==this.m_click_number?500:30))&&(this.m_last_click_time=a,this.m_click_number+=1,this.m_click_number>2&&(this.m_click_number=2),i&&this.m_click_cursor.charge(),!0)}input_click_entity(t,e){e!=o.NONE&&this.m_click_cursor.activate_by_enemy_select(t)}input_click_position(t,e){this.m_click_cursor.is_charge()&&this.m_click_cursor.activate_by_position(t,e),this.m_click_cursor.deactivate_enemy_select()}reset_click(){this.m_click_number=0}get_click_cursor(){return this.m_click_cursor}get_cooldawns(){return this.m_cooldawns}get_person_cooldawns(t){return this.m_cooldawns.get_cooldawns(t)}get_person_effects(t){return this.m_effects.get_entity_effects(t)}get_level_tiles(){return this.m_level_tiles}get_player(){return this.m_player}get_monsters(){return this.m_monsters}get_bullets(){return this.m_bullets}get_person(t){if(t==this.m_player_id)return this.m_player;{const e=this.m_monsters.get(t);if(e)return e}return null}get_bullet(t){if(this.m_bullets.has(t)){const e=this.m_bullets.get(t);if(e)return e}return null}get_entity_position(t){if(t==this.m_player_id)return this.m_player.get_tfm().translation();{const e=this.m_monsters.get(t);if(e)return e.get_tfm().translation()}return[]}delete_tile(t){this.m_level_tiles.has(t)&&this.m_level_tiles.delete(t)}create_tile(t,e,_,s){this.m_level_tiles.set(_,new O(t,e,this.m_level_tile_size,s))}set_player_id(t){this.m_player_id=t,this.m_player.set_id(t),this.m_cooldawns.add_entity(t)}entity_start_shift(t){this.m_player_id==t&&this.m_click_cursor.deactivate()}is_player(t){return this.m_player_id==t}set_player_radius(t){this.m_player.set_radius(t)}set_entity_attack_distance(t,e){if(this.m_player_id==t)this.m_player.set_attack_distance(e);else if(this.m_monsters.has(t)){const _=this.m_monsters.get(t);_&&_.set_attack_distance(e)}}set_entity_life(t,e,_){if(this.m_player_id==t)this.m_player.set_life(e,_);else if(this.m_monsters.has(t)){const s=this.m_monsters.get(t);s&&s.set_life(e,_)}}set_entity_activate_shield(t,e){if(this.m_player_id==t)this.m_player.set_active_shield(e),this.m_click_cursor.deactivate();else if(this.m_monsters.has(t)){const _=this.m_monsters.get(t);_&&_.set_active_shield(e)}}set_entity_shield(t,e,_){if(this.m_player_id==t)this.m_player.set_shield(e,_);else if(this.m_monsters.has(t)){const s=this.m_monsters.get(t);s&&s.set_shield(e,_)}}set_entity_dead(t,e){if(this.m_player_id==t)this.m_player.set_is_dead(e),e&&this.m_click_cursor.deactivate_enemy_select();else{if(this.m_monsters.has(t)){const _=this.m_monsters.get(t);_&&_.set_is_dead(e)}e&&this.m_click_cursor.deactivate_by_entity_remove(t,!0)}}set_entity_alive(t){if(this.m_player_id==t)this.m_player.set_alive();else if(this.m_monsters.has(t)){const e=this.m_monsters.get(t);e&&e.set_alive()}}set_entity_attack_time(t,e){this.m_player_id}set_entity_select_radius(t,e){if(t==this.m_player_id)this.m_player.set_select_radius(e);else if(this.m_monsters.has(t)){const _=this.m_monsters.get(t);_&&_.set_select_radius(e)}}create_monster(t){const e=new K(t);e.set_visible_search_cone(this.m_visible_search_cones),this.m_cooldawns.add_entity(t),this.m_monsters.set(t,e)}create_bullet(t,e){const _=new B(t,e);this.m_bullets.set(t,_)}post_monster_create(t){this.m_click_cursor.activate_by_entity_remember(t)}set_entity_position(t,e,_){if(t==this.m_player_id)this.m_player.set_position(e,_);else if(this.m_monsters.has(t)){const s=this.m_monsters.get(t);s&&s.set_position(e,_)}else if(this.m_bullets.has(t)){const s=this.m_bullets.get(t);s&&s.set_position(e,_)}}set_monster_radius(t,e){if(this.m_monsters.has(t)){const _=this.m_monsters.get(t);_&&_.set_radius(e)}}set_monster_search_radius(t,e){if(this.m_monsters.has(t)){const _=this.m_monsters.get(t);_&&_.set_search_radius(e)}}set_monster_search_spread(t,e){if(this.m_monsters.has(t)){const _=this.m_monsters.get(t);_&&_.set_search_spread(e)}}set_entity_team(t,e){if(t==this.m_player_id)this.m_player.set_team(e);else if(this.m_monsters.has(t)){const _=this.m_monsters.get(t);_&&_.set_team(e)}}set_entity_angle(t,e){if(t==this.m_player_id)this.m_player.set_angle(e);else if(this.m_monsters.has(t)){const _=this.m_monsters.get(t);_&&_.set_angle(e)}else if(this.m_bullets.has(t)){const _=this.m_bullets.get(t);_&&_.set_angle(e)}}set_entity_move(t,e){if(t==this.m_player_id)this.m_player.set_move(e);else if(this.m_monsters.has(t)){const _=this.m_monsters.get(t);_&&_.set_move(e)}}set_entity_hide(t,e){if(t==this.m_player_id)this.m_player.set_is_hide(e);else if(this.m_monsters.has(t)){const _=this.m_monsters.get(t);_&&_.set_is_hide(e)}}set_bullet_target_position(t,e,_){if(this.m_bullets.has(t)){const s=this.m_bullets.get(t);s&&s.set_debug_target(e,_)}}activate_monster_search_cones(){this.m_visible_search_cones=!0;for(const[t,e]of this.m_monsters)e.set_visible_search_cone(!0)}deactivate_monster_search_cones(){this.m_visible_search_cones=!1;for(const[t,e]of this.m_monsters)e.set_visible_search_cone(!1)}entity_start_melee_attack(t,e,_,s){this.m_effects.add_melee_attack(t,e,_,s)}entity_finish_melee_attack(t){this.m_effects.remove_melee_attack(t)}entity_start_range_attack(t,e){this.m_effects.add_range_attack(t,e)}entity_finish_range_attack(t){this.m_effects.remove_range_attack(t)}entity_start_hand_attack(t,e,_){this.m_effects.add_hand_attack(t,e,_)}entity_finish_hand_attack(t){this.m_effects.remove_hand_attack(t)}entity_start_shadow_attack(t,e,_){this.m_effects.add_shadow_attack(t,e,_)}entity_finish_shadow_attack(t){this.m_effects.remove_shadow_attack(t)}entity_finish_skill(t,e){this.m_effects.remove_skill(t,e)}entity_start_stun(t,e){t==this.m_player_id&&this.m_click_cursor.deactivate_enemy_select(),this.m_effects.add_stun(t,e)}entity_finish_stun(t){this.m_effects.remove_stun(t)}entity_start_hide_cast(t,e){this.m_effects.add_hide_cast(t,e)}entity_finish_hide_cast(t){this.m_effects.remove_hide_cast(t)}entity_start_skill_round_attack(t,e,_){this.m_effects.add_skill_round_attack(t,e,_)}entity_start_skill_stun_cone(t,e,_,s){this.m_effects.add_skill_stun_cone(t,e,_,s)}remove_monster(t){this.m_monsters.has(t)&&(this.m_click_cursor.deactivate_by_entity_remove(t,!1),this.m_monsters.delete(t)),this.m_cooldawns.remove_entity(t)}remove_bullet(t){this.m_bullets.delete(t)}}function $(t,e){const _=t.getBoundingClientRect();return[e.clientX-_.left,e.clientY-_.top]}function Q(t,e){const _=t.getBoundingClientRect(),s=e.touches;return s&&s.length>0?[e.touches[0].clientX-_.left,e.touches[0].clientY-_.top]:[]}class X{}class J extends X{constructor(t){super(),this.m_html_element=document.getElementById(t)}show(){this.m_html_element&&(this.m_html_element.style.visibility="visible")}hide(){this.m_html_element&&(this.m_html_element.style.visibility="hidden")}}class Z extends J{constructor(t){super(t)}set_text(t){this.m_html_element&&(this.m_html_element.innerText=t)}}class tt extends Z{m_accumulator=0;m_ticks=0;m_value=0;constructor(t){super(t)}update(t){this.m_accumulator+=t,this.m_ticks+=1,this.m_accumulator>2&&(this.m_value=this.m_ticks/this.m_accumulator,this.m_accumulator=0,this.m_ticks=0,this.set_text((Math.round(100*this.m_value)/100).toFixed(2).toString()))}}class et{constructor(t,e){this.m_total_element=new Z(t),this.m_visible_element=new Z(e)}update_values(t,e){this.m_total_element&&this.m_total_element.set_text(t.toString()),this.m_visible_element&&this.m_visible_element.set_text((e+1).toString())}}class _t{m_active=!0;assign_fps_element(t){this.m_fps=new tt(t)}assign_count_elements(t,e){this.m_items=new et(t,e)}assign_pause_screen(t){this.m_pause_screen=new J(t)}assign_control_keyboard(t){this.m_control_keyboard=new J(t)}assign_control_touch(t){this.m_control_touch=new J(t)}assign_loading(t){this.m_loading=new J(t)}assign_position(t){this.m_position=new Z(t)}update_count_values(t,e){this.m_items&&this.m_items.update_values(t,e)}update_position(t){this.m_position&&t.length>=2&&this.m_position.set_text("("+t[0].toFixed(2).toString()+", "+t[1].toFixed(2).toString()+")")}on_pause(t){this.m_pause_screen.show(),t?(this.m_control_touch.show(),this.m_control_keyboard.hide()):(this.m_control_touch.hide(),this.m_control_keyboard.show())}off_pause(){this.m_pause_screen.hide(),this.m_control_keyboard.hide(),this.m_control_touch.hide()}loading_hide(){this.m_loading.hide()}update(t){this.m_active&&this.m_fps.update(t)}}function st(t,e,_,s){const i=Math.floor(4294967295*Math.random());s?e.settings_set_seed(_,12):e.settings_set_seed(_,i),e.settings_set_rvo_time_horizon(_,.25),s?e.settings_set_generate(_,18,6,6,2):e.settings_set_generate(_,22,2,4,10),e.settings_set_use_debug(_,s),t.debug_define_draw_flag(s),e.settings_set_debug_flags(_,!0,!1,!1,!1,!1,!1,!0),s&&e.settings_set_react_attack(_,!1),e.settings_set_snap_to_navmesh(_,!0),e.settings_set_use_rvo(_,!0),e.settings_set_path_recalculate_time(_,1,.1),e.settings_set_velocity_boundary_control(_,!0),e.settings_set_level_tile_size(_,1.5),e.settings_set_tiles_visible_radius(_,12),e.settings_set_search_system_chunk_count(_,5),e.settings_set_visible_quad_size(_,18),e.settings_set_neighbourhood_quad_size(_,1),e.settings_set_search_quad_size(_,5.2),e.settings_set_mid_quad_size(_,4),e.settings_set_player(_,.5,5,12,24,1,1,3,7,1,.5,1,.5),e.settings_set_default_empty_weapon(_,.5,1,.75,1.5,4,5),e.settings_set_default_monster_person(_,.5,3,8,5,Math.PI/2.5,-1),s?(e.settings_set_monster_iddle_time(_,1e3,2e3),e.settings_set_monsters_per_room(_,5,50)):(e.settings_set_monster_iddle_time(_,1,2),e.settings_set_monsters_per_room(_,3,5))}function it(t,e){t.dev_add_sword_to_player(e.m_game_ptr,1,.75,1.25,7,12,Math.PI/2,2),t.dev_add_bow_to_player(e.m_game_ptr,5.5,.5,.75,7,7,12)}class at{m_module=void 0;m_is_start=!1;m_is_wait_click=!1;m_activated_skill=f.NONE;m_wtc_tfm=new v;m_wtc_scale=1;m_is_left_mouse_press=!1;m_is_right_mouse_press=!1;m_last_touch_time=performance.now();m_last_touch_coords=[0,0];m_total_level_entities=0;m_is_game_active=!0;m_is_pause=!1;m_is_touch=!1;constructor(){globalThis.host={define_level:this.define_level.bind(this),define_navmesh:this.define_navmesh.bind(this),define_total_tiles:this.define_total_tiles.bind(this),tile_delete:this.tile_delete.bind(this),tile_create:this.tile_create.bind(this),create_player:this.create_player.bind(this),update_entity_params:this.update_entity_params.bind(this),create_monster:this.create_monster.bind(this),create_bullet:this.create_bullet.bind(this),define_person_changes:this.define_person_changes.bind(this),define_bullet_changes:this.define_bullet_changes.bind(this),remove_entity:this.remove_entity.bind(this),define_total_update_entities:this.define_total_update_entities.bind(this),entity_start_shift:this.entity_start_shift.bind(this),entity_finish_shift:this.entity_finish_shift.bind(this),entity_activate_shield:this.entity_activate_shield.bind(this),entity_release_shield:this.entity_release_shield.bind(this),entity_start_melee_attack:this.entity_start_melee_attack.bind(this),entity_finish_melee_attack:this.entity_finish_melee_attack.bind(this),entity_start_range_attack:this.entity_start_range_attack.bind(this),entity_finish_range_attack:this.entity_finish_range_attack.bind(this),entity_start_hand_attack:this.entity_start_hand_attack.bind(this),entity_finish_hand_attack:this.entity_finish_hand_attack.bind(this),entity_start_shadow_attack:this.entity_start_shadow_attack.bind(this),entity_finish_shadow_attack:this.entity_finish_shadow_attack.bind(this),entity_finish_skill:this.entity_finish_skill.bind(this),entity_start_cooldawn:this.entity_start_cooldawn.bind(this),entity_start_stun:this.entity_start_stun.bind(this),entity_finish_stun:this.entity_finish_stun.bind(this),click_entity:this.click_entity.bind(this),click_position:this.click_position.bind(this),entity_dead:this.entity_dead.bind(this),entity_damaged:this.entity_damaged.bind(this),entity_switch_hide:this.entity_switch_hide.bind(this),entity_start_hide:this.entity_start_hide.bind(this),entity_finish_hide:this.entity_finish_hide.bind(this),entity_start_skill_round_attack:this.entity_start_skill_round_attack.bind(this),entity_start_skill_stun_cone:this.entity_start_skill_stun_cone.bind(this),entity_resurrect:this.entity_resurrect.bind(this),command_skill_result:this.command_skill_result.bind(this),debug_entity_walk_path:this.debug_entity_walk_path.bind(this),debug_close_entity:this.debug_close_entity.bind(this),debug_visible_quad:this.debug_visible_quad.bind(this),debug_neighbourhood_quad:this.debug_neighbourhood_quad.bind(this),debug_search_quad:this.debug_search_quad.bind(this),debug_mid_quad:this.debug_mid_quad.bind(this),debug_enemies_list:this.debug_enemies_list.bind(this)},this.m_ui=new _t,this.m_ui.assign_fps_element("fps"),this.m_ui.assign_count_elements("level_count","visible_count"),this.m_ui.assign_pause_screen("pause"),this.m_ui.assign_control_keyboard("control_keyboard"),this.m_ui.assign_control_touch("control_touch"),this.m_ui.assign_loading("loading"),this.m_ui.assign_position("position"),this.m_scene_canvas=document.getElementById("canvas"),this.m_scene_ctx=this.m_scene_canvas.getContext("2d"),this.m_map_canvas=document.getElementById("map_canvas"),this.m_map_ctx=this.m_map_canvas.getContext("2d"),this.setup_canvas_size(),this.m_map_canvas.style.pointerEvents="none",this.m_current_time=performance.now(),window.addEventListener("contextmenu",(t=>t.preventDefault()));const e=this;document.onkeydown=function(t){return e.key_event(t.key),!(" "==t.key)},e.m_is_touch="ontouchstart"in window||navigator.maxTouchPoints>0,e.m_is_touch?(this.m_scene_canvas.addEventListener("touchstart",(t=>{t.preventDefault(),e.touch_start_event(t)})),this.m_scene_canvas.addEventListener("touchend",(t=>{t.preventDefault(),e.touch_end_event(t)}))):(this.m_scene_canvas.addEventListener("mousedown",(function(t){e.mouse_press_event(t)})),this.m_scene_canvas.addEventListener("mouseup",(function(t){e.mouse_release_event(t)})),document.onmousemove=function(t){e.m_mouse_event=t}),document.addEventListener("visibilitychange",(function(){e.visibilitychange_event()})),window.addEventListener("resize",(function(){e.setup_canvas_size()})),fetch("/games/ProjectH/build/game_api.wasm").then((t=>WebAssembly.compileStreaming(t))).then((_=>t(_,{env:{}}).then((t=>{e.m_module=t,console.log("finish to load the module:",(performance.now()-e.m_current_time)/1e3,"seconds"),e.m_current_time=performance.now();const _=t.create_settings();st(this,t,_,!1),e.m_game_ptr=t.create_game(_),console.log("generate the level:",(performance.now()-e.m_current_time)/1e3,"seconds"),e.m_current_time=performance.now(),it(t,e),e.start(),e.m_is_start=!0,e.m_ui.off_pause(),e.m_ui.loading_hide()}))))}setup_canvas_size(){const t=window.innerWidth,e=window.innerHeight;let _=1200,s=700;(t<1200||e<700)&&(_=t,s=e);const i=document.getElementsByClassName("resizable_width");for(let t=0;t<i.length;t++){i[t].style.width=_+"px"}const a=document.getElementsByClassName("resizable_height");for(let t=0;t<a.length;t++){a[t].style.height=s+"px"}this.m_scene_canvas&&(this.m_scene_canvas.width=_,this.m_scene_canvas.height=s),this.m_map_canvas&&(this.m_map_canvas.width=_,this.m_map_canvas.height=s);const n=document.getElementById("window");n&&(n.style.left=(t-_)/2+"px",n.style.top=(e-s)/2+"px"),this.on_canvas_resize(_,s)}visibilitychange_event(){document.hidden?this.deactivate():this.m_is_pause||this.activate()}activate(){this.m_is_game_active=!0,this.m_current_time=performance.now(),this.m_ui.off_pause()}deactivate(){this.m_is_game_active=!1,this.m_ui.on_pause(this.m_is_touch)}toggle_activate(){this.m_is_game_active?(this.deactivate(),this.m_is_pause=!0):(this.activate(),this.m_is_pause=!1)}click_event(t,e,_,s,i){if(this.m_scene.input_click(t,e,_,s,i))if(this.m_is_wait_click&&this.m_activated_skill!=f.NONE){this.m_module.game_skill_target(this.m_game_ptr,_,s,this.m_activated_skill);this.m_is_wait_click=!1,this.m_activated_skill=f.NONE}else this.m_module.game_client_point(this.m_game_ptr,_,s)}activate_target_skill(t){this.m_is_wait_click=!0,this.m_activated_skill=f.STUN_CONE;const e=this.m_scene.get_click_cursor().get_entity_select();if(e){const _=e.get_translation();this.m_module.game_skill_target(this.m_game_ptr,_[0],_[1],t),this.m_is_wait_click=!1,this.m_activated_skill=f.NONE}}touch_start_event(t){if(this.m_is_start&&this.m_is_game_active)if(2==t.touches.length)this.m_module.game_client_shield(this.m_game_ptr);else if(1==t.touches.length){const e=Q(this.m_scene_canvas,t);if(e.length>0){const t=performance.now(),_=this.point_to_world(e[0],e[1]);t-this.m_last_touch_time<200&&Math.abs(_[0]-this.m_last_touch_coords[0])<2&&Math.abs(_[1]-this.m_last_touch_coords[1])<2?this.m_module.game_client_shift(this.m_game_ptr,_[0],_[1]):this.click_event(e[0],e[1],_[0],_[1],!0),this.m_last_touch_time=t,this.m_last_touch_coords[0]=_[0],this.m_last_touch_coords[1]=_[1]}}}touch_end_event(t){this.m_module.game_client_release_shield(this.m_game_ptr)}mouse_press_event(t){this.m_mouse_event=t;const e=0==t.button,_=2==t.button;if(this.m_is_start&&this.m_is_game_active){if(e){this.m_is_left_mouse_press=!0;const e=$(this.m_scene_canvas,t),_=this.point_to_world(e[0],e[1]);this.click_event(e[0],e[1],_[0],_[1],!0)}_&&(this.m_is_right_mouse_press=!0,this.m_module.game_client_shield(this.m_game_ptr))}}mouse_release_event(t){const e=0==t.button,_=2==t.button;this.m_is_start&&(e&&(this.m_is_left_mouse_press=!1,this.m_scene.reset_click()),_&&(this.m_is_right_mouse_press=!1,this.m_module.game_client_release_shield(this.m_game_ptr)))}key_event(t){if(this.m_is_wait_click=!1,this.m_activated_skill=f.NONE,this.m_is_start)if("Escape"==t)this.toggle_activate();else if(this.m_is_game_active)if("s"==t){const t=$(this.m_scene_canvas,this.m_mouse_event),e=this.point_to_world(t[0],t[1]),_=this.m_module.dev_create_virtual_sword(this.m_game_ptr,.75,.5,1.5,6,4,1.5,Math.PI/2);this.m_module.dev_game_spawn_monster(this.m_game_ptr,.5,e[0],e[1],3,12,_,5,Math.PI/2,-1,!1)}else if("S"==t){const t=$(this.m_scene_canvas,this.m_mouse_event),e=this.point_to_world(t[0],t[1]),_=this.m_module.dev_create_virtual_bow(this.m_game_ptr,5.5,.5,.75,12,5,12);this.m_module.dev_game_spawn_monster(this.m_game_ptr,.4,e[0],e[1],4,8,_,5,Math.PI/2,-2,!0)}else if("q"==t)this.m_module.game_skill_nontarget(this.m_game_ptr,f.ROUND_ATTACK);else if("w"==t)this.activate_target_skill(f.STUN_CONE);else if("r"==t)this.m_module.dev_game_resurrect_player(this.m_game_ptr);else if("a"==t)this.m_module.game_make_aggressive(this.m_game_ptr);else if("d"==t)this.m_module.game_damage_all_entities(this.m_game_ptr,1.5);else if("t"==t)this.m_module.game_stun_all_entities(this.m_game_ptr,1);else if("1"==t)this.m_module.dev_player_equip_free_hands(this.m_game_ptr);else if("2"==t)this.m_module.dev_player_equip_sword(this.m_game_ptr);else if("3"==t)this.m_module.dev_player_equip_bow(this.m_game_ptr);else if("m"==t)this.m_map.toggle_active();else if("h"==t)this.m_is_left_mouse_press||this.m_is_right_mouse_press||this.m_module.game_client_toggle_hide(this.m_game_ptr);else if("i"==t)this.debug_toggle_draw_flag();else if("+"==t)this.m_map.scale_up();else if("-"==t)this.m_map.scale_down();else if(" "==t){const t=$(this.m_scene_canvas,this.m_mouse_event),e=this.point_to_world(t[0],t[1]);this.m_module.game_client_shift(this.m_game_ptr,e[0],e[1])}}update(){if(this.m_is_game_active){if(this.m_is_left_mouse_press&&this.m_mouse_event&&this.m_scene_canvas){const t=$(this.m_scene_canvas,this.m_mouse_event),e=this.point_to_world(t[0],t[1]);this.click_event(t[0],t[1],e[0],e[1],!1)}const t=performance.now(),e=(t-this.m_current_time)/1e3;this.m_current_time=t,this.m_total_level_entities=0,this.m_module&&this.m_module.game_update(this.m_game_ptr,e),this.m_scene.update(e),this.m_ui.update(e),this.m_ui.update_count_values(this.m_total_level_entities,this.m_scene.get_monsters().size),this.m_ui.update_position(this.m_scene.get_player().get_translation())}this.draw_map()}draw_map(){this.m_map&&this.m_map.draw()}define_level(t,e,_){this.m_level_width=t,this.m_level_height=e,this.m_level_tile_size=_,this.m_scene=new j(this.m_level_width,this.m_level_height,this.m_level_tile_size),this.m_wtc_scale=50/this.m_level_tile_size,this.m_wtc_tfm.set_uniform_scale(this.m_wtc_scale)}define_navmesh(t,e,_){this.m_map=new E(this.m_map_ctx,this.m_wtc_tfm,this.m_level_tile_size,t,e,_)}define_total_tiles(t){}tile_delete(t){this.m_scene.delete_tile(t),this.scene_tile_delete(t)}tile_create(t,e,_,s){const i=t*this.m_level_tile_size,a=e*this.m_level_tile_size;this.m_scene.create_tile(i,a,_,s),this.scene_tile_create(i,a,_,s)}create_player(t,e,_,s,i){this.m_scene.set_player_id(t),this.m_scene.set_player_radius(s),this.m_scene.set_entity_position(t,e,_),this.scene_create_player(s)}update_entity_params(t,e,_,s,i,a,n,h,r){this.m_scene.set_entity_dead(t,e),this.m_scene.set_entity_attack_distance(t,h),this.m_scene.set_entity_life(t,_,s),this.m_scene.set_entity_shield(t,i,a),this.m_scene.set_entity_attack_time(t,r),this.m_scene.set_entity_select_radius(t,n),this.scene_update_entity_params(t,e,_,s,n,h,r)}create_monster(t,e,_,s,i,a,n,h){this.m_scene.create_monster(t),this.m_scene.set_entity_angle(t,s),this.m_scene.set_monster_radius(t,i),this.m_scene.set_entity_position(t,e,_),this.m_scene.set_entity_team(t,h),this.m_scene.set_monster_search_radius(t,a),this.m_scene.set_monster_search_spread(t,n),this.m_scene.post_monster_create(t),this.scene_create_monster(t,e,_,i,a,n,h)}create_bullet(t,e,_,s,i,a,n){this.m_scene.create_bullet(t,n),this.m_scene.set_entity_position(t,e,_),this.m_scene.set_entity_angle(t,a),this.m_scene.set_bullet_target_position(t,s,i),this.scene_create_bullet(t,e,_,s,i,a,n)}define_person_changes(t,e,_,s,i,a,n,h,r,m){this.m_scene.set_entity_position(t,e,_),this.m_scene.set_entity_angle(t,s),this.m_scene.set_entity_move(t,i),this.m_scene.set_entity_life(t,a,n),this.m_scene.set_entity_shield(t,h,r),this.m_scene.set_entity_dead(t,m),this.scene_update_entity_position(t,e,_),this.scene_update_entity_angle(t,s),this.scene_update_entity_move_status(t,i),this.scene_update_entity_life(t,a,n),this.scene_update_entity_shield(t,h,r)}define_bullet_changes(t,e,_,s){this.m_scene.set_entity_position(t,e,_),this.m_scene.set_entity_angle(t,s),this.scene_update_entity_position(t,e,_),this.scene_update_entity_angle(t,s)}remove_entity(t,e,_){e==i.MONSTER?(this.m_scene.remove_monster(t),this.scene_remove_monster(t)):e==i.BULLET&&(this.m_scene.remove_bullet(t),this.scene_remove_bullet(t,_))}define_total_update_entities(t){this.m_total_level_entities=t}entity_start_shift(t){this.m_scene.entity_start_shift(t),this.scene_entity_start_shift(t)}entity_finish_shift(t){this.scene_entity_finish_shift(t)}entity_activate_shield(t){this.m_scene.set_entity_activate_shield(t,!0),this.scene_entity_activate_shield(t)}entity_release_shield(t){this.m_scene.set_entity_activate_shield(t,!1),this.scene_entity_release_shield(t)}entity_start_melee_attack(t,e,_,s){this.m_scene.entity_start_melee_attack(t,e,_,s),this.scene_entity_start_melee_attack(t,e,_,s)}entity_finish_melee_attack(t,e){this.m_scene.entity_finish_melee_attack(t),this.scene_entity_finish_melee_attack(t)}entity_start_range_attack(t,e){this.m_scene.entity_start_range_attack(t,e),this.scene_entity_start_range_attack(t,e)}entity_finish_range_attack(t,e){this.m_scene.entity_finish_range_attack(t),this.scene_entity_finish_range_attack(t)}entity_start_hand_attack(t,e,_){this.m_scene.entity_start_hand_attack(t,e,_),this.scene_entity_start_hand_attack(t,e,_)}entity_finish_hand_attack(t,e){this.m_scene.entity_finish_hand_attack(t),this.scene_entity_finish_hand_attack(t)}entity_start_shadow_attack(t,e,_){this.m_scene.entity_start_shadow_attack(t,e,_),this.scene_entity_start_shadow_attack(t,e,_)}entity_finish_shadow_attack(t,e){this.m_scene.entity_finish_shadow_attack(t),this.scene_entity_finish_shadow_attack(t)}entity_finish_skill(t,e,_){this.m_scene.entity_finish_skill(t,e),this.scene_entity_finish_skill(t,e)}entity_start_cooldawn(t,e,_){this.m_scene.get_cooldawns().start_cooldawn(t,e,_),this.scene_entity_start_cooldawn(t,e,_)}click_entity(t,e){this.m_scene.input_click_entity(t,e),this.scene_click_entity(t,e)}click_position(t,e){this.m_scene.input_click_position(t,e),this.scene_click_position(t,e)}entity_dead(t){this.m_scene.set_entity_dead(t,!0),this.scene_entity_dead(t)}entity_damaged(t,e,_,s){this.scene_entity_damaged(t,e,_,s)}entity_start_stun(t,e){this.m_scene.entity_start_stun(t,e),this.scene_entity_start_stun(t,e)}entity_finish_stun(t){this.m_scene.entity_finish_stun(t),this.scene_entity_finish_stun(t)}entity_switch_hide(t,e){this.m_scene.set_entity_hide(t,e),this.scene_entity_switch_hide(t,e),this.m_scene.is_player(t)&&(e?(this.m_scene.activate_monster_search_cones(),this.scene_player_activate_hide()):(this.m_scene.deactivate_monster_search_cones(),this.scene_player_deactivate_hide()))}entity_start_hide(t,e){this.m_scene.entity_start_hide_cast(t,e),this.scene_entity_start_hide_activation(t,e)}entity_finish_hide(t,e){this.m_scene.entity_finish_hide_cast(t),this.scene_entity_finish_hide_activation(t,e)}entity_start_skill_round_attack(t,e,_){this.m_scene.entity_start_skill_round_attack(t,e,_),this.scene_entity_start_skill_round_attack(t,e,_)}entity_start_skill_stun_cone(t,e,_,s){this.m_scene.entity_start_skill_stun_cone(t,e,_,s),this.scene_entity_start_skill_stun_cone(t,e,_,s)}entity_resurrect(t,e,_){this.m_scene.set_entity_alive(t),this.m_scene.set_entity_life(t,e,_),this.scene_entity_resurrect(t,e,_)}command_skill_result(t,e,_,s,i,a){t&&e&&this.m_scene.get_click_cursor().activate_by_enemy_select(_),this.scene_command_skill_result(t,e,_,s,i,a)}debug_entity_walk_path(t,e){const _=new Float32Array(e.length);for(let t=0;t<_.length;t++)_[t]=e[t];this.debug_entity_trajectory(t,_)}debug_close_entity(t,e,_,s,i,a){this.debug_close_entity_pair(t,e,_,s,i,a)}debug_visible_quad(t,e,_,s){this.debug_player_visible_quad(t,e,_,s)}debug_neighbourhood_quad(t,e,_,s){this.debug_player_neighbourhood_quad(t,e,_,s)}debug_search_quad(t,e,_,s){this.debug_player_search_quad(t,e,_,s)}debug_mid_quad(t,e,_,s){this.debug_player_mid_quad(t,e,_,s)}debug_enemies_list(t,e,_){const s=new Int32Array(_.length);for(let t=0;t<s.length;t++)s[t]=_[t];this.m_scene.set_monster_search_radius(t,e),this.debug_enemies_search(t,e,s)}}function nt(t,e,_){if(_.get_active()){const s=_.get_type();if(s==S.POSITION){const s=Math.pow(Math.min(_.get_proportion(),1),.15);t.save(),t.lineWidth=1,t.fillStyle="rgba(232, 128, 51, 0.25)",t.strokeStyle=T,t.beginPath();const i=e.multiply_array(_.get_translation()),a=e.apply_scale(.5)*s;t.arc(i[0],i[1],a,0,2*Math.PI),t.fill(),t.stroke(),t.beginPath(),t.fillStyle=T,t.arc(i[0],i[1],2,0,2*Math.PI),t.fill(),t.restore()}else if(s==S.ENEMY_ENTITY){t.save(),t.lineWidth=1,t.fillStyle="rgba(209, 63, 52, 0.25)",t.strokeStyle="rgba(217, 33, 20, 0.75)",t.beginPath();const s=e.multiply_array(_.get_translation()),i=e.apply_scale(_.get_size());t.arc(s[0],s[1],i,0,2*Math.PI),t.fill(),t.stroke()}}}function ht(t,e,_){const s=e.multiply_array(_.get_translation()),i=e.apply_scale(_.get_tile_size()),a=_.get_type();t.save(),t.lineWidth=.2,t.fillStyle="rgb(192, 192, 192)",t.strokeStyle="rgb(152, 152, 152)",t.beginPath(),0==a?t.rect(s[0],s[1],i,i):2==a?t.rect(s[0]+i/2,s[1]+i/2,i/2,i/2):3==a?t.rect(s[0],s[1]+i/2,i/2,i/2):4==a?t.rect(s[0]+i/2,s[1],i/2,i/2):5==a?t.rect(s[0],s[1],i/2,i/2):6==a?t.rect(s[0],s[1]+i/2,i,i/2):7==a?t.rect(s[0],s[1],i/2,i):8==a?t.rect(s[0],s[1],i,i/2):9==a?t.rect(s[0]+i/2,s[1],i/2,i):10==a?(t.moveTo(s[0],s[1]),t.lineTo(s[0],s[1]+i),t.lineTo(s[0]+i/2,s[1]+i),t.lineTo(s[0]+i/2,s[1]+i/2),t.lineTo(s[0]+i,s[1]+i/2),t.lineTo(s[0]+i,s[1])):11==a?(t.moveTo(s[0],s[1]),t.lineTo(s[0],s[1]+i/2),t.lineTo(s[0]+i/2,s[1]+i/2),t.lineTo(s[0]+i/2,s[1]+i),t.lineTo(s[0]+i,s[1]+i),t.lineTo(s[0]+i,s[1])):12==a?(t.moveTo(s[0],s[1]),t.lineTo(s[0],s[1]+i),t.lineTo(s[0]+i,s[1]+i),t.lineTo(s[0]+i,s[1]+i/2),t.lineTo(s[0]+i/2,s[1]+i/2),t.lineTo(s[0]+i/2,s[1])):13==a&&(t.moveTo(s[0],s[1]+i/2),t.lineTo(s[0],s[1]+i),t.lineTo(s[0]+i,s[1]+i),t.lineTo(s[0]+i,s[1]),t.lineTo(s[0]+i/2,s[1]),t.lineTo(s[0]+i/2,s[1]+i/2)),t.fill(),t.stroke(),t.restore()}function rt(t,e,_,s,i,a,n){t.save(),t.fillStyle=a,t.strokeStyle=n,t.beginPath(),t.arc(_[0],_[1],e.apply_scale(s),0,2*Math.PI),t.fill(),t.beginPath(),t.arc(_[0],_[1],e.apply_scale(s*i),0,2*Math.PI),t.stroke(),t.restore()}function mt(t,e,s,i,a,n,h,r,m,l,o,d,g,y){const p=s.get_tfm(),f=s.get_is_dead(),b=e.compose_tfms(p),v=b.multiply(0,0),w=s.get_search_radius(),T=b.apply_scale(w);if(s.get_debug_draw()){if(!f){t.save(),t.strokeStyle="rgba(64, 64, 64, 0.1)";const _=s.get_select_radius(),i=e.apply_scale(_);t.beginPath(),t.arc(v[0],v[1],i,0,2*Math.PI),t.stroke(),t.restore()}t.save(),t.strokeStyle=f?k:g,t.beginPath();const _=s.get_attack_distance(),i=b.apply_scale(_);t.arc(v[0],v[1],i,0,2*Math.PI),t.stroke(),t.restore(),t.save(),t.strokeStyle=f?k:"rgba(186, 77, 19, 0.25)",t.beginPath(),t.arc(v[0],v[1],T,0,2*Math.PI),t.stroke(),t.restore()}const x=s.get_radius(),E=b.apply_scale(x),N=b.multiply(x*Math.SQRT2,0),I=p.rotation();if(s.get_is_visible_search_cone()&&!f){const e=I+s.get_search_spread()/2,_=I-s.get_search_spread()/2;t.save(),t.fillStyle="rgba(217, 180, 35, 0.5)",t.strokeStyle="rgba(166, 111, 23, 0.5)",t.lineWidth=1,t.beginPath(),t.arc(v[0],v[1],T,e,_,!0),t.lineTo(v[0],v[1]),t.closePath(),t.fill(),t.stroke(),t.restore()}if(t.save(),t.lineWidth=n,t.fillStyle=f?k:h,t.strokeStyle=d,t.beginPath(),t.arc(v[0],v[1],E,I+Math.PI/4,2*Math.PI+I-Math.PI/4),t.lineTo(N[0],N[1]),t.fill(),y&&t.stroke(),!f){t.fillStyle=s.get_move()==c.NONE?s.get_is_hide()?o:m:s.get_move()==c.WALK?s.get_is_hide()?o:r:l,t.beginPath();const e=s.get_life_proportion();e>=1?t.arc(v[0],v[1],b.apply_scale(.8*x),0,2*Math.PI):t.arc(v[0],v[1],b.apply_scale(.8*x),I-(1-e)*Math.PI,I+(1-e)*Math.PI,!0),t.lineTo(v[0],v[1]),t.fill(),y&&t.stroke()}t.restore();const S=s.get_shield_active(),M=s.get_shield_proportion();if((S||M<1&&!f)&&(t.save(),t.strokeStyle=S?"rgba(45, 71, 77, 0.75)":"rgba(45, 71, 77, 0.25)",t.lineWidth=S?4:2,t.beginPath(),t.arc(v[0],v[1],b.apply_scale(x*Math.SQRT2),I-M*Math.PI/2,I+M*Math.PI/2),t.stroke(),t.restore()),!f){for(let[e,_]of i){t.save();let s=0;e==u.SHIFT?(t.lineWidth=2,t.strokeStyle="rgba(255, 255, 255, 0.25)",s=6):e==u.MELEE_ATTACK?(t.lineWidth=2,t.strokeStyle="rgba(255, 164, 164, 0.5)",s=8):e==u.HIDE_ACTIVATION?(t.lineWidth=2,t.strokeStyle="rgba(255, 255, 255, 0.25)",s=10):e==u.SHADOW_ATTACK?(t.lineWidth=2,t.strokeStyle="rgba(255, 164, 164, 0.5)",s=12):e==u.RANGE_ATTACK?(t.lineWidth=2,t.strokeStyle="rgba(219, 149, 35, 0.5)",s=8):e==u.HAND_ATTACK?(t.lineWidth=2,t.strokeStyle="rgba(103, 136, 174, 0.25)",s=8):e==u.SKILL_ROUND_ATTACK?(t.lineWidth=4,t.strokeStyle="rgba(41, 128, 34, 0.5)",s=6):e==u.SKILL_STUN_CONE&&(t.lineWidth=4,t.strokeStyle="rgba(34, 128, 89, 0.5)",s=6),t.beginPath(),t.arc(v[0],v[1],s,I,2*Math.PI*(1-_[1]/_[0])+I),t.stroke(),t.restore()}for(const e of a){const s=e.type();if(s==_.MELEE_ATTACK){const _=e,s=_.distance(),i=_.spread(),a=_.proportion(),n=b.apply_scale(s),h=I+i/2,r=h-i*a;t.save(),t.fillStyle=A,t.strokeStyle=A,t.beginPath(),t.arc(v[0],v[1],n,h,r,!0),t.arc(v[0],v[1],E,r,h,!1),t.closePath(),t.fill(),t.beginPath(),t.arc(v[0],v[1],n,h,h-i,!0),t.arc(v[0],v[1],E,h-i,h,!1),t.closePath(),t.stroke(),t.restore()}else if(s==_.STUN){rt(t,b,v,1.1*x,1-e.proportion(),"rgba(40, 111, 224, 0.25)","rgba(134, 173, 235, 1.0)")}else if(s==_.HIDE_ACTIVATION){rt(t,b,v,x,1-e.proportion(),"rgba(63, 74, 77, 0.75)","rgba(21, 29, 43, 1.0)")}else if(s==_.SHADOW_ATTACK){const _=e,s=_.distance(),i=_.proportion(),a=b.apply_scale(s);t.save(),t.strokeStyle="rgba(212, 37, 6, 0.5)",t.lineWidth=4,t.beginPath(),t.moveTo(v[0]+Math.cos(I)*E,v[1]+Math.sin(I)*E);const n=E+i*(a-E);t.lineTo(v[0]+Math.cos(I)*n,v[1]+Math.sin(I)*n),t.stroke(),t.restore()}else if(s==_.HAND_ATTACK){const _=e,s=_.distance(),i=_.proportion(),a=b.apply_scale(s);t.save(),t.fillStyle="rgba(103, 136, 174, 0.5)",t.beginPath(),t.moveTo(v[0],v[1]),t.lineTo(v[0]+Math.cos(I-Math.PI/4)*E,v[1]+Math.sin(I-Math.PI/4)*E);const n=E+i*(a-E);t.lineTo(v[0]+Math.cos(I)*n,v[1]+Math.sin(I)*n),t.lineTo(v[0]+Math.cos(I+Math.PI/4)*E,v[1]+Math.sin(I+Math.PI/4)*E),t.closePath(),t.fill(),t.restore()}else if(s==_.RANGE_ATTACK){const _=e.proportion();t.save(),t.strokeStyle="rgba(219, 149, 35, 0.75)",t.lineWidth=2,t.beginPath(),t.arc(v[0],v[1],E+6,I-Math.PI/2,I+Math.PI/2);const s=_*(E+6);t.lineTo(v[0]-Math.cos(I)*s,v[1]-Math.sin(I)*s),t.closePath(),t.stroke(),t.restore()}else if(s==_.SKILL_ROUND_ATTACK){const _=e,s=_.proportion(),i=_.area_size(),a=b.apply_scale(i);t.save(),t.strokeStyle="rgba(199, 38, 38, 0.35)",t.fillStyle="rgba(199, 38, 38, 0.25)",t.beginPath(),t.arc(v[0],v[1],E,0,2*Math.PI),t.stroke(),t.beginPath(),t.arc(v[0],v[1],a,0,2*Math.PI),t.stroke(),t.beginPath(),t.arc(v[0],v[1],E,I,I+2*Math.PI*s),t.arc(v[0],v[1],a,I+2*Math.PI*s,I,!0),t.closePath(),t.fill(),t.restore()}else if(s==_.SKILL_STUN_CONE){const _=e,s=_.proportion(),i=_.cone_spread(),a=_.cone_size(),n=b.apply_scale(a);t.save(),t.strokeStyle="rgba(199, 38, 38, 0.35)",t.fillStyle="rgba(199, 38, 38, 0.25)",t.beginPath(),t.arc(v[0],v[1],E,I-i/2,I+i/2),t.arc(v[0],v[1],n,I+i/2,I-i/2,!0),t.closePath(),t.stroke(),t.beginPath(),t.arc(v[0],v[1],E,I-i/2,I+i/2),t.arc(v[0],v[1],E+(n-E)*s,I+i/2,I-i/2,!0),t.closePath(),t.fill(),t.restore()}}}}function ct(t,e,_,s,i){mt(t,e,_,s,i,1,"rgba(114, 186, 89, 0.5)","rgba(91, 128, 78, 0.5)",w,"rgba(91, 128, 78, 0.25)","rgba(91, 128, 78, 0.1)","rgb(74, 193, 33)","rgba(74, 193, 33, 0.25)",false)}function lt(t,e,_,s,i){mt(t,e,_,s,i,1,"rgba(171, 105, 73, 0.5)","rgba(196, 94, 45, 0.5)","rgba(196, 94, 45, 0.75)","rgba(196, 94, 45, 0.25)","rgba(196, 94, 45, 0.1)","rgb(226, 55, 27)","rgb(226, 55, 27, 0.15)",false)}function ot(t,e,_){const s=_.get_tfm(),i=e.compose_tfms(s).multiply(0,0),a=s.rotation();if(_.get_debug_draw()){t.save(),t.strokeStyle="rgba(32, 32, 59, 0.25)",t.lineWidth=1,t.beginPath();const s=e.multiply(_.get_debug_target_x(),_.get_debug_target_y());t.moveTo(i[0],i[1]),t.lineTo(s[0],s[1]),t.stroke(),t.fillStyle="rgba(32, 32, 59, 0.75)",t.beginPath(),t.arc(s[0],s[1],2,0,2*Math.PI),t.fill(),t.restore()}t.save(),_.get_type()==n.ARROW&&(t.fillStyle="rgba(32, 32, 59, 0.3)",t.beginPath(),t.arc(i[0],i[1],4,a-Math.PI/2,a+Math.PI/2),t.lineTo(i[0]-12*Math.cos(a),i[1]-12*Math.sin(a)),t.fill()),t.restore()}function dt(t,e,_){t.save(),t.lineWidth=1,t.strokeStyle="rgb(94, 178, 219)",t.beginPath();const s=_.length/2,i=e.multiply(_[0],_[1]);t.moveTo(i[0],i[1]);for(let i=1;i<s;i++){const s=e.multiply(_[2*i],_[2*i+1]);t.lineTo(s[0],s[1])}t.stroke(),t.restore(),t.save(),t.fillStyle="rgb(53, 129, 166)";for(let i=0;i<s;i++){t.beginPath();const s=e.multiply(_[2*i],_[2*i+1]);t.arc(s[0],s[1],2,0,2*Math.PI),t.fill()}t.restore()}function ut(t,e,_){t.save(),t.lineWidth=1,t.strokeStyle="rgb(82, 209, 77)",t.beginPath();const s=_.length/4;for(let i=0;i<s;i++){const s=e.multiply(_[4*i],_[4*i+1]),a=e.multiply(_[4*i+2],_[4*i+3]);t.moveTo(s[0],s[1]),t.lineTo(a[0],a[1])}t.stroke(),t.restore()}function gt(t,e,_,s,i){t.save(),t.lineWidth=i,t.strokeStyle=s,t.beginPath();const a=e.multiply(_[0],_[1]),n=e.multiply(_[2],_[3]);t.moveTo(a[0],a[1]),t.lineTo(n[0],a[1]),t.lineTo(n[0],n[1]),t.lineTo(a[0],n[1]),t.closePath(),t.stroke(),t.restore()}function yt(t,e,_,s,i,a,n){if(s&&gt(t,e,_,a,n),i){const s=_[2]-_[0],i=_[3]-_[1],h=new Float32Array(4);h[0]=_[0]-s,h[1]=_[1]-i,h[2]=_[2]+s,h[3]=_[3]+i,gt(t,e,h,a,n)}}function pt(t,e,_){yt(t,e,_,!0,!0,"rgba(111, 156, 227, 0.5)",1)}function ft(t,e,_){yt(t,e,_,!0,!0,"rgb(134, 227, 111)",1)}function bt(t,e,_){yt(t,e,_,!0,!0,"rgb(191, 147, 23)",1)}function vt(t,e,_){yt(t,e,_,!0,!0,"rgba(117, 12, 28, 0.25)",1)}function wt(t,e,_){t.save(),t.lineWidth=1,t.strokeStyle="rgba(186, 77, 19, 0.7)";for(let s=0;s<_.length/4;s++){t.beginPath();const i=e.multiply(_[4*s],_[4*s+1]),a=e.multiply(_[4*s+2],_[4*s+3]);t.moveTo(i[0],i[1]),t.lineTo(a[0],a[1]),t.stroke()}t.restore()}new class extends at{m_camera_position_x=0;m_camera_position_y=0;m_debug_trajectories=new Map;m_is_draw_visible_rect=!1;m_debug_visible_rect=new Float32Array(4);m_is_draw_neighbourhood_rect=!1;m_debug_neighbourhood_rect=new Float32Array(4);m_is_draw_search_rect=!1;m_debug_search_rect=new Float32Array(4);m_is_draw_mid_rect=!1;m_debug_mid_rect=new Float32Array(4);m_use_debug_draw=!1;constructor(){super(),this.m_canvas_width=this.m_scene_canvas.width,this.m_canvas_height=this.m_scene_canvas.height,this.m_debug_trajectories.clear(),this.m_debug_pairs=new Array,this.m_debug_enemies_lines=new Array}start(){this.update_process()}on_canvas_resize(t,e){this.m_canvas_width=t,this.m_canvas_height=e,this.m_wtc_tfm.set_translation(this.m_canvas_width/2-this.m_camera_position_x*this.m_wtc_scale,this.m_canvas_height/2-this.m_camera_position_y*this.m_wtc_scale)}point_to_world(t,e){return this.m_wtc_tfm.inverse().multiply(t,e)}scene_tile_delete(t){}scene_tile_create(t,e,_,s){}scene_create_player(t){this.m_scene.get_player().set_debug_draw(this.m_use_debug_draw)}scene_update_entity_params(t,e,_,s,i,a,n){}scene_update_entity_position(t,e,_){this.m_scene.is_player(t)&&(this.m_camera_position_x=1*e+0*this.m_camera_position_x,this.m_camera_position_y=1*_+0*this.m_camera_position_y,this.m_wtc_tfm.set_translation(this.m_canvas_width/2-this.m_camera_position_x*this.m_wtc_scale,this.m_canvas_height/2-this.m_camera_position_y*this.m_wtc_scale))}scene_update_entity_angle(t,e){}scene_update_entity_move_status(t,e){}scene_update_entity_life(t,e,_){}scene_update_entity_shield(t,e,_){}scene_create_monster(t,e,_,s,i,a,n){const h=this.m_scene.get_person(t);h&&h.set_debug_draw(this.m_use_debug_draw)}scene_create_bullet(t,e,_,s,i,a,n){const h=this.m_scene.get_bullet(t);h&&h.set_debug_draw(this.m_use_debug_draw)}scene_remove_monster(t){}scene_remove_bullet(t,e){}scene_entity_start_shift(t){}scene_entity_finish_shift(t){}scene_entity_activate_shield(t){}scene_entity_release_shield(t){}scene_entity_start_melee_attack(t,e,_,s){}scene_entity_finish_melee_attack(t){}scene_entity_start_range_attack(t,e){}scene_entity_finish_range_attack(t){}scene_entity_start_hand_attack(t,e,_){}scene_entity_finish_hand_attack(t){}scene_entity_start_shadow_attack(t,e,_){}scene_entity_finish_shadow_attack(t){}scene_entity_finish_skill(t,e){}scene_entity_start_cooldawn(t,e,_){}scene_click_entity(t,e){}scene_click_position(t,e){}scene_entity_damaged(t,e,_,s){}scene_entity_dead(t){}scene_entity_start_stun(t,e){}scene_entity_finish_stun(t){}scene_entity_start_hide_activation(t,e){}scene_entity_finish_hide_activation(t,e){}scene_entity_start_skill_round_attack(t,e,_){}scene_entity_start_skill_stun_cone(t,e,_,s){}scene_entity_switch_hide(t,e){}scene_player_activate_hide(){}scene_player_deactivate_hide(){}scene_entity_resurrect(t,e,_){}scene_command_skill_result(t,e,_,s,i,a){}debug_entity_trajectory(t,e){this.m_use_debug_draw&&this.m_debug_trajectories.set(t,e)}debug_close_entity_pair(t,e,_,s,i,a){this.m_use_debug_draw&&(this.m_debug_pairs.push(e),this.m_debug_pairs.push(_),this.m_debug_pairs.push(i),this.m_debug_pairs.push(a))}debug_player_visible_quad(t,e,_,s){this.m_use_debug_draw&&(this.m_debug_visible_rect[0]=t,this.m_debug_visible_rect[1]=e,this.m_debug_visible_rect[2]=_,this.m_debug_visible_rect[3]=s,this.m_is_draw_visible_rect=!0)}debug_player_neighbourhood_quad(t,e,_,s){this.m_use_debug_draw&&(this.m_debug_neighbourhood_rect[0]=t,this.m_debug_neighbourhood_rect[1]=e,this.m_debug_neighbourhood_rect[2]=_,this.m_debug_neighbourhood_rect[3]=s,this.m_is_draw_neighbourhood_rect=!0)}debug_player_search_quad(t,e,_,s){this.m_use_debug_draw&&(this.m_debug_search_rect[0]=t,this.m_debug_search_rect[1]=e,this.m_debug_search_rect[2]=_,this.m_debug_search_rect[3]=s,this.m_is_draw_search_rect=!0)}debug_player_mid_quad(t,e,_,s){this.m_use_debug_draw&&(this.m_debug_mid_rect[0]=t,this.m_debug_mid_rect[1]=e,this.m_debug_mid_rect[2]=_,this.m_debug_mid_rect[3]=s,this.m_is_draw_mid_rect=!0)}debug_enemies_search(t,e,_){if(this.m_use_debug_draw){const e=this.m_scene.get_person(t);if(e){const t=e.get_translation();for(let e of _){const _=this.m_scene.get_person(e);if(_){const e=_.get_translation();t.length>=2&&e.length>=2&&(this.m_debug_enemies_lines.push(t[0]),this.m_debug_enemies_lines.push(t[1]),this.m_debug_enemies_lines.push(e[0]),this.m_debug_enemies_lines.push(e[1]))}}}}}debug_define_draw_flag(t){this.m_use_debug_draw=t}debug_toggle_draw_flag(){if(this.m_use_debug_draw=!this.m_use_debug_draw,this.m_use_debug_draw){this.m_scene.get_player().set_debug_draw(!0);for(const[t,e]of this.m_scene.get_monsters())e.set_debug_draw(!0);for(const[t,e]of this.m_scene.get_bullets())e.set_debug_draw(!0)}else{this.m_is_draw_visible_rect=!1,this.m_is_draw_neighbourhood_rect=!1,this.m_is_draw_search_rect=!1,this.m_is_draw_mid_rect=!1;this.m_scene.get_player().set_debug_draw(!1);for(const[t,e]of this.m_scene.get_monsters())e.set_debug_draw(!1);for(const[t,e]of this.m_scene.get_bullets())e.set_debug_draw(!1)}}update_process(){this.m_debug_trajectories.clear(),this.m_debug_pairs.length=0,this.m_debug_enemies_lines=new Array,this.update(),this.draw_scene(),window.requestAnimationFrame(this.update_process.bind(this))}draw_scene(){var t,e,_;this.m_scene_ctx.clearRect(0,0,this.m_canvas_width,this.m_canvas_height),t=this.m_scene_ctx,e=this.m_scene_canvas.width,_=this.m_scene_canvas.height,t.save(),t.fillStyle="rgb(64, 64, 64)",t.fillRect(0,0,e,_),t.restore();const s=this.m_scene.get_level_tiles();for(let[t,e]of s)ht(this.m_scene_ctx,this.m_wtc_tfm,e);const i=this.m_scene.get_click_cursor();nt(this.m_scene_ctx,this.m_wtc_tfm,i);const a=this.m_scene.get_player(),n=a.get_id();ct(this.m_scene_ctx,this.m_wtc_tfm,a,this.m_scene.get_person_cooldawns(n),this.m_scene.get_person_effects(n));const h=this.m_scene.get_monsters();for(let[t,e]of h){const t=e.get_id();lt(this.m_scene_ctx,this.m_wtc_tfm,e,this.m_scene.get_person_cooldawns(t),this.m_scene.get_person_effects(t))}const r=this.m_scene.get_bullets();for(const[t,e]of r)ot(this.m_scene_ctx,this.m_wtc_tfm,e);for(let[t,e]of this.m_debug_trajectories)dt(this.m_scene_ctx,this.m_wtc_tfm,e);ut(this.m_scene_ctx,this.m_wtc_tfm,this.m_debug_pairs),this.m_is_draw_visible_rect&&pt(this.m_scene_ctx,this.m_wtc_tfm,this.m_debug_visible_rect),this.m_is_draw_neighbourhood_rect&&ft(this.m_scene_ctx,this.m_wtc_tfm,this.m_debug_neighbourhood_rect),this.m_is_draw_search_rect&&bt(this.m_scene_ctx,this.m_wtc_tfm,this.m_debug_search_rect),this.m_is_draw_mid_rect&&vt(this.m_scene_ctx,this.m_wtc_tfm,this.m_debug_mid_rect),wt(this.m_scene_ctx,this.m_wtc_tfm,this.m_debug_enemies_lines)}};
//# sourceMappingURL=module.js.map
